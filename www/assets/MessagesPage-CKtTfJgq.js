import{g as te,a as re,r as d,u as se,az as ae,j as t,s as ne,c as oe,b as ie,H as le,f as de,h as ce,a2 as V,$ as G,J as xe,B as s,T as i,I as _,aA as he,L as me,q as ue,aB as pe,V as J,v as z,a6 as Q,a9 as ge,w as fe,aC as be,a1 as ye,aD as je,n as ve,aE as we,ap as X,G as h}from"./index-Cr_aSuNE.js";import{u as Se}from"./index-DdEHrxem.js";import{A as _e}from"./arrow-left-DFM7ANa-.js";import{S as Ce}from"./send-BePmK5Ja.js";function Ie(a){return te("MuiListItemAvatar",a)}re("MuiListItemAvatar",["root","alignItemsFlexStart"]);const ke=a=>{const{alignItems:m,classes:e}=a;return ie({root:["root",m==="flex-start"&&"alignItemsFlexStart"]},Ie,e)},ze=ne("div",{name:"MuiListItemAvatar",slot:"Root",overridesResolver:(a,m)=>{const{ownerState:e}=a;return[m.root,e.alignItems==="flex-start"&&m.alignItemsFlexStart]}})({minWidth:56,flexShrink:0,variants:[{props:{alignItems:"flex-start"},style:{marginTop:8}}]}),Me=d.forwardRef(function(m,e){const c=se({props:m,name:"MuiListItemAvatar"}),{className:C,...o}=c,u=d.useContext(ae),p={...c,alignItems:u.alignItems},I=ke(p);return t.jsx(ze,{className:oe(I.root,C),ownerState:p,ref:e,...o})}),De=()=>{var B,N,P,F,K,O;const{user:a}=le(),m=de(),e=ce(m.breakpoints.down("md")),[c,C]=d.useState([]),[o,u]=d.useState(null),[p,I]=d.useState([]),[b,M]=d.useState(""),[Y,W]=d.useState(!0),[k,R]=d.useState(!1),[A,y]=d.useState(!0),L=d.useRef(null),D=d.useRef(null),[T,j]=d.useState(null),$=Se({onSwipedRight:()=>{e&&o&&(y(!0),u(null))},trackMouse:!1,preventScrollOnSwipe:!0,delta:50}),Z=()=>{var r;(r=L.current)==null||r.scrollIntoView({behavior:"smooth"})},E=async()=>{if(a){W(!0);try{const[r,n]=await Promise.all([h.from("conversations").select("*").eq("buyer_id",a.id).order("updated_at",{ascending:!1}),h.from("conversations").select("*").eq("seller_id",a.id).order("updated_at",{ascending:!1})]);if(r.error)throw r.error;if(n.error)throw n.error;const l=[...r.data||[],...n.data||[]].sort((x,f)=>new Date(f.updated_at).getTime()-new Date(x.updated_at).getTime()),g=await Promise.all((l||[]).map(async x=>{var H;const f=x.buyer_id===a.id?x.seller_id:x.buyer_id,[v,w,S]=await Promise.all([h.from("items").select("*").eq("id",x.item_id).maybeSingle(),h.from("profiles").select("*").eq("id",f).maybeSingle(),h.from("messages").select("*").eq("conversation_id",x.id).order("created_at",{ascending:!1}).limit(1)]),ee=await h.from("messages").select("id",{count:"exact"}).eq("conversation_id",x.id).eq("read",!1).neq("sender_id",a.id);return{...x,item:v.data||void 0,other_user:w.data||void 0,last_message:(H=S.data)==null?void 0:H[0],unread_count:ee.count||0}}));C(g)}catch(r){console.error("Error loading conversations:",r)}finally{W(!1)}}},q=async r=>{try{const{data:n,error:l}=await h.from("messages").select("*").eq("conversation_id",r).order("created_at",{ascending:!0});if(l)throw l;I(n||[]),await h.from("messages").update({read:!0}).eq("conversation_id",r).neq("sender_id",(a==null?void 0:a.id)||""),setTimeout(Z,100)}catch(n){console.error("Error loading messages:",n)}},U=async()=>{var r;if(!(!b.trim()||!o||!a)){R(!0);try{const{error:n}=await h.from("messages").insert({conversation_id:o.id,sender_id:a.id,content:b.trim()});if(n)throw n;M(""),await q(o.id),await E(),(r=D.current)==null||r.focus()}catch(n){console.error("Error sending message:",n)}finally{R(!1)}}};return d.useEffect(()=>{E()},[a]),d.useEffect(()=>{o&&(q(o.id),e&&y(!1))},[o,e]),d.useEffect(()=>{if(c.length>0&&!o){const r=c.find(n=>(n.unread_count||0)>0);r&&u(r)}},[c]),Y?t.jsx(V,{maxWidth:"xl",sx:{py:e?0:4,height:e?"100%":"auto",flex:e?1:"unset",display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsx(G,{size:48,thickness:4})}):t.jsxs(V,{maxWidth:"xl",sx:{py:e?0:3,px:e?0:2,height:e?"100%":"calc(100vh - 88px)",flex:e?1:"unset"},children:[t.jsxs(xe,{elevation:e?0:2,sx:{height:"100%",display:"flex",overflow:"hidden",borderRadius:e?0:3,bgcolor:"background.paper"},children:[t.jsxs(s,{sx:{width:e?"100%":380,borderRight:1,borderColor:"divider",display:e&&!A?"none":"flex",flexDirection:"column",bgcolor:"background.default"},children:[t.jsxs(s,{sx:{p:e?2:3,bgcolor:"primary.main",color:"primary.contrastText"},children:[t.jsxs(s,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:e?1.5:1},children:[t.jsx(i,{variant:e?"h6":"h5",fontWeight:600,children:"Nachrichten"}),!e&&t.jsx(_,{size:"small",sx:{color:"primary.contrastText"},children:t.jsx(he,{size:20})})]}),c.length>0&&t.jsxs(i,{variant:"body2",sx:{opacity:.9},children:[c.length," ",c.length===1?"Konversation":"Konversationen"]})]}),t.jsx(me,{sx:{flex:1,overflow:"auto",p:0},children:c.length===0?t.jsxs(s,{sx:{p:e?3:4,textAlign:"center"},children:[t.jsx(i,{variant:"body1",color:"text.secondary",sx:{mb:1},children:"Keine Konversationen"}),t.jsx(i,{variant:"body2",color:"text.secondary",children:"Starte eine Unterhaltung über ein Angebot"})]}):c.map((r,n)=>{var l,g,x,f,v,w,S;return t.jsxs(s,{children:[t.jsxs(ue,{selected:(o==null?void 0:o.id)===r.id,onClick:()=>{u(r),e&&y(!1)},sx:{py:e?2:2.5,px:e?2:2.5,transition:"all 0.2s ease","&.Mui-selected":{bgcolor:"primary.lighter",borderLeft:4,borderColor:"primary.main","&:hover":{bgcolor:"primary.lighter"}},"&:hover":{bgcolor:"action.hover"}},children:[t.jsx(Me,{children:t.jsx(pe,{overlap:"circular",anchorOrigin:{vertical:"bottom",horizontal:"right"},badgeContent:r.unread_count>0?t.jsx(s,{sx:{width:e?18:20,height:e?18:20,borderRadius:"50%",bgcolor:"error.main",color:"white",display:"flex",alignItems:"center",justifyContent:"center",fontSize:e?"0.7rem":"0.75rem",fontWeight:600,border:"2px solid white"},children:r.unread_count>9?"9+":r.unread_count}):null,children:t.jsx(J,{src:(l=r.item)==null?void 0:l.image_url,sx:{width:e?52:56,height:e?52:56,border:"2px solid",borderColor:"background.paper",boxShadow:1},children:((f=(x=(g=r.other_user)==null?void 0:g.full_name)==null?void 0:x[0])==null?void 0:f.toUpperCase())||"?"})})}),t.jsx(z,{sx:{ml:1.5},primary:t.jsxs(s,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:.5},children:[t.jsx(i,{variant:"subtitle1",fontWeight:r.unread_count>0?600:500,noWrap:!0,sx:{flex:1,mr:1,fontSize:e?"0.95rem":"1rem"},children:((v=r.other_user)==null?void 0:v.full_name)||"Unbekannt"}),r.last_message&&t.jsx(i,{variant:"caption",color:"text.secondary",sx:{flexShrink:0,fontSize:e?"0.7rem":"0.75rem"},children:ge(r.last_message.created_at)})]}),secondary:t.jsxs(t.Fragment,{children:[t.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:.5,mb:.5},children:[t.jsx(Q,{size:e?12:14,style:{opacity:.6}}),t.jsx(i,{variant:"caption",color:"text.secondary",noWrap:!0,component:"span",sx:{fontWeight:500,fontSize:e?"0.7rem":"0.75rem"},children:((w=r.item)==null?void 0:w.title)||"Item gelöscht"})]}),t.jsx(i,{variant:"body2",color:r.unread_count>0?"text.primary":"text.secondary",fontWeight:r.unread_count>0?500:400,noWrap:!0,component:"span",sx:{fontSize:e?"0.85rem":"0.875rem"},children:((S=r.last_message)==null?void 0:S.content)||"Noch keine Nachrichten"})]}),secondaryTypographyProps:{component:"div"}})]}),n<c.length-1&&t.jsx(fe,{variant:"inset",component:"li"})]},r.id)})})]}),t.jsx(s,{...$,sx:{flex:1,display:e&&A?"none":"flex",flexDirection:"column",touchAction:"pan-y",bgcolor:"background.default"},children:o?t.jsxs(t.Fragment,{children:[t.jsx(s,{sx:{p:e?1.5:2.5,bgcolor:"background.paper",borderBottom:1,borderColor:"divider",boxShadow:e?"0 2px 4px rgba(0,0,0,0.08)":"0 1px 3px rgba(0,0,0,0.05)"},children:t.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:e?1.5:2},children:[e&&t.jsx(_,{onClick:()=>{y(!0),u(null)},size:"small",sx:{"&:hover":{bgcolor:"action.hover"}},children:t.jsx(_e,{size:22})}),t.jsx(J,{src:(B=o.item)==null?void 0:B.image_url,sx:{width:e?40:48,height:e?40:48,border:"2px solid",borderColor:"primary.main",boxShadow:1},children:((F=(P=(N=o.other_user)==null?void 0:N.full_name)==null?void 0:P[0])==null?void 0:F.toUpperCase())||"?"}),t.jsxs(s,{sx:{flex:1,minWidth:0},children:[t.jsx(i,{variant:e?"body1":"subtitle1",fontWeight:600,noWrap:!0,children:((K=o.other_user)==null?void 0:K.full_name)||"Unbekannt"}),t.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:.5},children:[t.jsx(Q,{size:e?11:12,style:{opacity:.6}}),t.jsx(i,{variant:"caption",color:"text.secondary",noWrap:!0,sx:{fontSize:e?"0.7rem":"0.75rem"},children:((O=o.item)==null?void 0:O.title)||"Item gelöscht"})]})]}),!e&&t.jsx(_,{size:"small",onClick:r=>j(r.currentTarget),children:t.jsx(be,{size:20})})]})}),t.jsx(s,{sx:{flex:1,overflow:"auto",p:e?2:3,bgcolor:e?"grey.100":"grey.50",backgroundImage:e?"linear-gradient(180deg, rgba(0,0,0,0.02) 0%, rgba(0,0,0,0.03) 100%)":"linear-gradient(180deg, rgba(0,0,0,0.01) 0%, rgba(0,0,0,0.02) 100%)"},children:p.length===0?t.jsx(s,{sx:{height:"100%",display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center",px:3},children:t.jsxs(s,{children:[t.jsx(i,{variant:"body1",color:"text.secondary",gutterBottom:!0,children:"Noch keine Nachrichten"}),t.jsx(i,{variant:"body2",color:"text.secondary",children:"Sende die erste Nachricht"})]})}):t.jsxs(t.Fragment,{children:[p.map((r,n)=>{const l=r.sender_id===(a==null?void 0:a.id),g=n===0||new Date(p[n-1].created_at).toDateString()!==new Date(r.created_at).toDateString();return t.jsxs(s,{children:[g&&t.jsx(s,{sx:{display:"flex",justifyContent:"center",my:e?2:3},children:t.jsx(ye,{label:new Date(r.created_at).toLocaleDateString("de-DE",{weekday:e?"short":"long",year:"numeric",month:e?"short":"long",day:"numeric"}),size:"small",sx:{bgcolor:"background.paper",boxShadow:1,fontWeight:500,fontSize:e?"0.7rem":"0.75rem",height:e?24:28}})}),t.jsx(je,{in:!0,timeout:300,children:t.jsx(s,{sx:{display:"flex",justifyContent:l?"flex-end":"flex-start",mb:e?1:1.5},children:t.jsxs(s,{sx:{maxWidth:e?"80%":"75%",bgcolor:l?"primary.main":"background.paper",color:l?"primary.contrastText":"text.primary",px:e?1.5:2,py:e?1.25:1.5,borderRadius:l?e?"18px 18px 4px 18px":"20px 20px 4px 20px":e?"18px 18px 18px 4px":"20px 20px 20px 4px",boxShadow:l?2:1,transition:"all 0.2s ease","&:hover":{transform:e?"none":"translateY(-1px)",boxShadow:l?3:2}},children:[t.jsx(i,{variant:"body2",sx:{wordWrap:"break-word",whiteSpace:"pre-wrap",lineHeight:1.5,fontSize:e?"0.9rem":"1rem"},children:r.content}),t.jsx(i,{variant:"caption",sx:{opacity:l?.85:.7,display:"block",mt:.5,fontSize:e?"0.65rem":"0.7rem"},children:new Date(r.created_at).toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"})})]})})})]},r.id)}),t.jsx("div",{ref:L})]})}),t.jsx(s,{sx:{p:e?1.5:2.5,bgcolor:"background.paper",borderTop:1,borderColor:"divider",boxShadow:e?"0 -4px 12px rgba(0,0,0,0.06)":"0 -1px 3px rgba(0,0,0,0.05)"},children:t.jsxs(s,{sx:{display:"flex",gap:e?1:1.5,alignItems:"flex-end",bgcolor:e?"grey.100":"transparent",borderRadius:e?7:0,p:e?.75:0},children:[t.jsx(ve,{fullWidth:!0,inputRef:D,placeholder:"Nachricht...",value:b,onChange:r=>M(r.target.value),onKeyPress:r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),U())},multiline:!0,maxRows:e?3:4,disabled:k,variant:"outlined",size:"small",sx:{"& .MuiOutlinedInput-root":{bgcolor:e?"transparent":"grey.50",borderRadius:e?0:3,fontSize:"0.95rem",py:e?.5:.75,px:1.5,transition:"all 0.2s ease","& fieldset":{borderColor:e?"transparent":"divider",borderWidth:e?0:1},"&:hover":{bgcolor:e?"transparent":"grey.100","& fieldset":{borderColor:e?"transparent":"primary.light"}},"&.Mui-focused":{bgcolor:e?"transparent":"background.paper","& fieldset":{borderColor:e?"transparent":"primary.main",borderWidth:e?0:2}}},"& .MuiOutlinedInput-input":{padding:0}}}),t.jsx(_,{color:"primary",onClick:U,disabled:k||!b.trim(),sx:{bgcolor:"primary.main",color:"white",width:e?46:48,height:e?46:48,flexShrink:0,transition:"all 0.2s cubic-bezier(0.4, 0, 0.2, 1)",boxShadow:2,mr:e?.5:0,display:"flex",alignItems:"center",justifyContent:"center",p:0,"&:hover":{bgcolor:"primary.dark",transform:"scale(1.05)",boxShadow:3},"&:active":{transform:"scale(0.95)"},"&.Mui-disabled":{bgcolor:"grey.300",color:"grey.500",boxShadow:0}},children:k?t.jsx(G,{size:e?20:22,color:"inherit"}):t.jsx(Ce,{size:e?20:22,style:{transform:"translateX(1px)"}})})]})})]}):t.jsx(s,{sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center",px:3},children:t.jsxs(s,{children:[t.jsx(i,{variant:e?"h6":"h5",color:"text.secondary",fontWeight:500,gutterBottom:!0,children:"Wähle eine Konversation"}),t.jsxs(i,{variant:"body2",color:"text.secondary",children:["Starte eine Unterhaltung aus der Liste ",e?"oben":"links"]})]})})})]}),t.jsxs(we,{anchorEl:T,open:!!T,onClose:()=>j(null),transformOrigin:{horizontal:"right",vertical:"top"},anchorOrigin:{horizontal:"right",vertical:"bottom"},children:[t.jsx(X,{onClick:()=>{j(null)},children:t.jsx(z,{children:"Alle als gelesen markieren"})}),t.jsx(X,{onClick:()=>{j(null)},children:t.jsx(z,{children:"Konversation archivieren"})})]})]})};export{De as MessagesPage};
