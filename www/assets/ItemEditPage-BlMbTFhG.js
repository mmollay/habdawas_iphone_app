import{g as os,a as cs,r as t,u as ds,j as e,s as hs,c as us,b as ps,T as v,an as gs,B as a,J as ne,aj as xs,ah as W,ao as ee,I as ae,w as E,ap as ms,aq as fs,n as M,a9 as js,ar as F,Y as ys,R as _s,H as Cs,f as bs,h as vs,G as c,a0 as se,a3 as Ge,F as te,y as I,as as Ss,a5 as Oe,X as ws,D as Ds,i as ks,l as Is,A as As}from"./index-DGPOwJJr.js";import{C as Ze,M as zs,B as Ws,D as Es}from"./MultiImageUpload-CcYahZ3B.js";import{C as Je}from"./chevron-down-D3Id4EJ6.js";import{C as Qe}from"./Collapse-Dmhu021x.js";import{R as Ps,a as ie}from"./RadioGroup-Dy1vNQ9b.js";import{A as Xe}from"./arrow-left-Dg_Vpcc7.js";import{S as Bs}from"./star-CCnGXB6K.js";import"./CategoryDropdown-C5_L9UJB.js";import"./Search-B8gagK-N.js";import"./alert-circle-BIXLrZ7T.js";import"./leaf-BMOzByc0.js";function Ts(o){return os("MuiDialogContentText",o)}cs("MuiDialogContentText",["root"]);const Ls=o=>{const{classes:d}=o,S=ps({root:["root"]},Ts,d);return{...d,...S}},Us=hs(v,{shouldForwardProp:o=>gs(o)||o==="classes",name:"MuiDialogContentText",slot:"Root"})({}),qs=t.forwardRef(function(d,p){const S=ds({props:d,name:"MuiDialogContentText"}),{children:r,className:P,...w}=S,C=Ls(w);return e.jsx(Us,{component:"p",variant:"body1",color:"textSecondary",ref:p,ownerState:w,className:us(C.root,P),...S,classes:C})}),Ms=({shippingEnabled:o,shippingCostType:d,shippingCost:p,shippingDescription:S,pickupEnabled:r,selectedAddressId:P,showLocationPublicly:w,locationDescription:C,addresses:V,onShippingEnabledChange:A,onShippingCostTypeChange:m,onShippingCostChange:O,onShippingDescriptionChange:Z,onPickupEnabledChange:f,onSelectedAddressChange:J,onShowLocationPubliclyChange:N,onLocationDescriptionChange:B,isMobile:D=!1,hideShippingPickupToggles:j=!1})=>{const[y,T]=t.useState(!0),[_,L]=t.useState(!0),b=V.filter(i=>i.address_type==="pickup_only"||i.address_type==="both");return e.jsxs(a,{children:[!j&&e.jsx(v,{variant:"h6",fontWeight:600,gutterBottom:!0,children:"Versand & Abholung"}),e.jsxs(a,{sx:{display:"flex",flexDirection:"column",gap:2},children:[o&&e.jsxs(ne,{elevation:0,sx:{border:"1px solid",borderColor:"divider",overflow:"hidden"},children:[!j&&e.jsxs(a,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",p:2,cursor:"pointer",bgcolor:y?"rgba(25, 118, 210, 0.04)":"transparent"},onClick:()=>T(!y),children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(xs,{size:20,color:"#1976d2"}),e.jsx(v,{variant:"subtitle1",fontWeight:600,children:"Versand"})]}),e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(W,{control:e.jsx(ee,{checked:o,onChange:i=>{i.stopPropagation(),A(i.target.checked)},onClick:i=>i.stopPropagation()}),label:"",sx:{m:0}}),e.jsx(ae,{size:"small",onClick:()=>T(!y),children:y?e.jsx(Ze,{size:20}):e.jsx(Je,{size:20})})]})]}),e.jsxs(Qe,{in:j||y&&o,children:[!j&&e.jsx(E,{}),e.jsxs(a,{sx:{p:2,display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(ms,{children:[e.jsx(fs,{children:"Versandkosten"}),e.jsxs(Ps,{value:d,onChange:i=>m(i.target.value),children:[e.jsx(W,{value:"free",control:e.jsx(ie,{}),label:"Kostenloser Versand"}),e.jsx(W,{value:"fixed",control:e.jsx(ie,{}),label:"Fester Betrag"}),e.jsx(W,{value:"ai_calculated",control:e.jsx(ie,{}),label:"KI-berechnet (basierend auf Gewicht & Maßen)"})]})]}),d==="fixed"&&e.jsx(M,{label:"Versandkosten",type:"number",value:p,onChange:i=>O(parseFloat(i.target.value)||0),fullWidth:!0,inputProps:{min:0,step:.5},helperText:"in Euro (€)"}),e.jsx(M,{label:"Versandinformationen",value:S,onChange:i=>Z(i.target.value),fullWidth:!0,multiline:!0,rows:D?2:3,placeholder:"z.B. Versand mit DHL, 1-3 Werktage"})]})]})]}),r&&e.jsxs(ne,{elevation:0,sx:{border:"1px solid",borderColor:"divider",overflow:"hidden"},children:[!j&&e.jsxs(a,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",p:2,cursor:"pointer",bgcolor:_?"rgba(25, 118, 210, 0.04)":"transparent"},onClick:()=>L(!_),children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(js,{size:20,color:"#1976d2"}),e.jsx(v,{variant:"subtitle1",fontWeight:600,children:"Abholung"})]}),e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(W,{control:e.jsx(ee,{checked:r,onChange:i=>{i.stopPropagation(),f(i.target.checked)},onClick:i=>i.stopPropagation()}),label:"",sx:{m:0}}),e.jsx(ae,{size:"small",onClick:()=>L(!_),children:_?e.jsx(Ze,{size:20}):e.jsx(Je,{size:20})})]})]}),e.jsxs(Qe,{in:j||_&&r,children:[!j&&e.jsx(E,{}),e.jsxs(a,{sx:{p:2,display:"flex",flexDirection:"column",gap:2},children:[e.jsx(M,{label:"Abholadresse",value:P,onChange:i=>J(i.target.value),fullWidth:!0,select:!0,helperText:b.length===0?"Bitte füge eine Abholadresse in den Einstellungen hinzu":"",children:b.length===0?e.jsx(F,{value:"",children:"Keine Adresse verfügbar"}):b.map(i=>e.jsx(F,{value:i.id,children:e.jsxs(a,{children:[e.jsx(v,{variant:"body2",fontWeight:600,children:i.name}),e.jsxs(v,{variant:"caption",color:"text.secondary",children:[i.address,", ",i.postal_code," ",i.city]})]})},i.id))}),e.jsx(W,{control:e.jsx(ee,{checked:w,onChange:i=>N(i.target.checked)}),label:"Vollständige Adresse öffentlich anzeigen"}),e.jsx(M,{label:"Abholhinweise",value:C,onChange:i=>B(i.target.value),fullWidth:!0,multiline:!0,rows:D?2:3,placeholder:"z.B. Hinterhof, Klingel oben rechts"})]})]})]})]})]})},Qs=()=>{const{id:o}=ys(),d=_s(),{user:p}=Cs(),S=bs(),r=vs(S.breakpoints.down("md")),[P,w]=t.useState(!0),[C,V]=t.useState(!1),[A,m]=t.useState(null),[O,Z]=t.useState(!1),[f,J]=t.useState(null),[N,B]=t.useState([]),[D,j]=t.useState(""),[y,T]=t.useState(""),[_,L]=t.useState(""),[b,i]=t.useState({}),[re,le]=t.useState(""),[oe,ce]=t.useState(""),[Q,de]=t.useState([]),[he,ue]=t.useState("published"),[Ye,H]=t.useState(!1),[R,pe]=t.useState(!1),[ge,xe]=t.useState(""),[me,fe]=t.useState(""),[je,ye]=t.useState(""),[_e,Ce]=t.useState(""),[be,ve]=t.useState(""),[Se,we]=t.useState(""),[X,De]=t.useState([]),[ke,Ie]=t.useState(""),[Ae,ze]=t.useState(""),[We,Ee]=t.useState(!1),[Y,Pe]=t.useState("fixed"),[Be,Te]=t.useState(5),[Le,Ue]=t.useState(""),[$,qe]=t.useState(!0),[U,Me]=t.useState(""),[Fe,Ve]=t.useState(!1),[Ne,He]=t.useState(""),[es,ss]=t.useState([]);t.useEffect(()=>{if(!p){d("/");return}ts(),is()},[o,p]);const ts=async()=>{var l;if(!(!o||!p))try{const{data:s,error:k}=await c.from("items").select("*").eq("id",o).maybeSingle();if(k)throw k;if(!s){m("Artikel nicht gefunden"),w(!1);return}if(s.user_id!==p.id){m("Keine Berechtigung zum Bearbeiten dieses Artikels"),w(!1);return}if(J(s),j(s.title||""),T(s.description||""),L(((l=s.price)==null?void 0:l.toString())||""),s.category_id){const{data:n}=await c.from("categories").select("*").eq("id",s.category_id).single();if(n){const h={};if(n.level===1)h.level1=n;else if(n.level===2){h.level2=n;const{data:u}=await c.from("categories").select("*").eq("id",n.parent_id).single();u&&(h.level1=u)}else if(n.level===3){h.level3=n;const{data:u}=await c.from("categories").select("*").eq("id",n.parent_id).single();if(u){h.level2=u;const{data:x}=await c.from("categories").select("*").eq("id",u.parent_id).single();x&&(h.level1=x)}}else if(n.level===4){h.level4=n;const{data:u}=await c.from("categories").select("*").eq("id",n.parent_id).single();if(u){h.level3=u;const{data:x}=await c.from("categories").select("*").eq("id",u.parent_id).single();if(x){h.level2=x;const{data:K}=await c.from("categories").select("*").eq("id",x.parent_id).single();K&&(h.level1=K)}}}i(h)}}le(s.brand||""),ce(s.condition||""),de(s.tags||[]),ue(s.status||"published"),xe(s.size||""),fe(s.weight||""),ye(s.dimensions_length||""),Ce(s.dimensions_width||""),ve(s.dimensions_height||""),we(s.material||""),De(s.colors||[]),Ie(s.style||""),ze(s.serial_number||""),Ee(s.snapshot_shipping_enabled||!1),Pe(s.snapshot_shipping_cost_type||"fixed"),Te(s.snapshot_shipping_cost||5),Ue(s.snapshot_shipping_description||""),qe(s.snapshot_pickup_enabled||!1),Me(s.selected_address_id||""),Ve(s.snapshot_show_location_publicly||!1),He(s.snapshot_location_description||"");const{data:z}=await c.from("item_images").select("*").eq("item_id",o).order("display_order",{ascending:!0});z&&z.length>0?B(z.map(n=>({id:n.id,preview:n.image_url,existingUrl:n.image_url,isPrimary:n.is_primary}))):s.image_url&&B([{id:"primary",preview:s.image_url,existingUrl:s.image_url,isPrimary:!0}])}catch(s){console.error("Error loading item:",s),m("Fehler beim Laden des Artikels")}finally{w(!1)}},is=async()=>{if(p)try{const{data:l,error:s}=await c.from("addresses").select("*").eq("user_id",p.id).in("address_type",["pickup_only","both"]).order("is_default",{ascending:!1});if(s)throw s;ss(l||[])}catch(l){console.error("Error loading addresses:",l)}},ns=async()=>{if(!(!p||!f)){pe(!0),m(null);try{const{error:l}=await c.from("items").delete().eq("id",f.id);if(l)throw l;d("/")}catch(l){console.error("Error deleting item:",l),m(l.message||"Fehler beim Löschen"),pe(!1),H(!1)}}},as=async()=>{var l,s,k,z;if(!(!p||!f)){if(!D.trim()||!y.trim()||!_){m("Bitte fülle alle Pflichtfelder aus");return}V(!0),m(null);try{const n=parseFloat(_.replace(",","."));if(isNaN(n))throw new Error("Ungültiger Preis");let h=f.image_url;await c.from("item_images").delete().eq("item_id",f.id);const u=[];for(const g of N){let G;if(g.file){const rs=g.file.name.split(".").pop(),$e=`${p.id}/${Date.now()}-${Math.random().toString(36).substring(7)}.${rs}`,{error:Ke}=await c.storage.from("item-images").upload($e,g.file);if(Ke)throw Ke;const{data:{publicUrl:ls}}=c.storage.from("item-images").getPublicUrl($e);G=ls}else if(g.existingUrl)G=g.existingUrl;else continue;u.push(G),g.isPrimary&&(h=G)}for(let g=0;g<u.length;g++)await c.from("item_images").insert({item_id:f.id,image_url:u[g],display_order:g,is_primary:u[g]===h});let x=null;if($&&U){const{data:g}=await c.from("addresses").select("*").eq("id",U).maybeSingle();x=g}const K=((l=b.level4)==null?void 0:l.id)||((s=b.level3)==null?void 0:s.id)||((k=b.level2)==null?void 0:k.id)||((z=b.level1)==null?void 0:z.id)||null,q={title:D.trim(),description:y.trim(),price:n,category_id:K,brand:re||null,condition:oe||null,tags:Q.length>0?Q:null,status:he,size:ge||null,weight:me||null,dimensions_length:je||null,dimensions_width:_e||null,dimensions_height:be||null,material:Se||null,colors:X.length>0?X:null,style:ke||null,serial_number:Ae||null,image_url:h,selected_address_id:$&&U?U:null,snapshot_shipping_enabled:We,snapshot_shipping_cost_type:Y,snapshot_shipping_cost:Y==="fixed"?Be:0,snapshot_shipping_description:Le||null,snapshot_pickup_enabled:$,snapshot_show_location_publicly:Fe,snapshot_location_description:Ne||null,updated_at:new Date().toISOString()};x&&(q.snapshot_pickup_address=x.address,q.snapshot_pickup_postal_code=x.postal_code,q.snapshot_pickup_city=x.city,q.snapshot_pickup_country=x.country);const{error:Re}=await c.from("items").update(q).eq("id",f.id);if(Re)throw Re;Z(!0),setTimeout(()=>{d(`/item/${f.id}`)},1500)}catch(n){console.error("Error saving item:",n),m(n.message||"Fehler beim Speichern")}finally{V(!1)}}};return P?e.jsx(a,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh"},children:e.jsx(se,{})}):A&&!f?e.jsx(a,{sx:{minHeight:"100vh",display:"flex",flexDirection:"column"},children:e.jsxs(Ge,{maxWidth:"md",sx:{py:8,flex:1},children:[e.jsx(te,{severity:"error",children:A}),e.jsx(I,{variant:"outlined",onClick:()=>d("/"),sx:{mt:2},startIcon:e.jsx(Xe,{size:20}),children:"Zurück zur Startseite"})]})}):e.jsxs(a,{sx:{minHeight:"100vh",display:"flex",flexDirection:"column",bgcolor:"#fafafa"},children:[e.jsxs(Ge,{maxWidth:"lg",sx:{py:r?2:4,flex:1,maxWidth:"1200px !important"},children:[e.jsxs(a,{sx:{mb:3,display:"flex",alignItems:"center",gap:2,flexWrap:"wrap"},children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:2,flex:1},children:[e.jsx(ae,{onClick:()=>d(`/item/${o}`),size:r?"small":"medium",children:e.jsx(Xe,{size:r?20:24})}),e.jsx(v,{variant:r?"h5":"h4",fontWeight:600,children:"Artikel bearbeiten"})]}),!r&&e.jsx(I,{variant:"outlined",onClick:()=>d("/"),startIcon:e.jsx(Ss,{size:20}),sx:{whiteSpace:"nowrap"},children:"Zurück zur Liste"})]}),A&&e.jsx(te,{severity:"error",sx:{mb:3},onClose:()=>m(null),children:A}),O&&e.jsx(te,{severity:"success",sx:{mb:3},children:"Artikel erfolgreich aktualisiert! Du wirst weitergeleitet..."}),e.jsxs(ne,{elevation:r?0:1,sx:{p:r?2:4},children:[e.jsxs(a,{sx:{display:"flex",flexDirection:"column",gap:4},children:[e.jsxs(a,{children:[e.jsx(v,{variant:"h6",fontWeight:600,gutterBottom:!0,children:"Bilder"}),e.jsx(zs,{images:N,onImagesChange:B})]}),e.jsx(E,{}),e.jsx(Ws,{title:D,description:y,price:_,category:b,brand:re,condition:oe,tags:Q,onTitleChange:j,onDescriptionChange:T,onPriceChange:L,onCategoryChange:i,onBrandChange:le,onConditionChange:ce,onTagsChange:de,isMobile:r}),e.jsx(E,{}),e.jsx(Es,{size:ge,weight:me,dimensionsLength:je,dimensionsWidth:_e,dimensionsHeight:be,material:Se,colors:X,style:ke,serialNumber:Ae,onSizeChange:xe,onWeightChange:fe,onDimensionsChange:(l,s,k)=>{ye(l),Ce(s),ve(k)},onMaterialChange:we,onColorsChange:De,onStyleChange:Ie,onSerialNumberChange:ze,isMobile:r}),e.jsx(E,{}),e.jsx(Ms,{shippingEnabled:We,shippingCostType:Y,shippingCost:Be,shippingDescription:Le,pickupEnabled:$,selectedAddressId:U,showLocationPublicly:Fe,locationDescription:Ne,addresses:es,onShippingEnabledChange:Ee,onShippingCostTypeChange:Pe,onShippingCostChange:Te,onShippingDescriptionChange:Ue,onPickupEnabledChange:qe,onSelectedAddressChange:Me,onShowLocationPubliclyChange:Ve,onLocationDescriptionChange:He,isMobile:r}),e.jsx(E,{}),e.jsxs(a,{children:[e.jsx(v,{variant:"h6",fontWeight:600,gutterBottom:!0,children:"Status & Verwaltung"}),e.jsxs(a,{sx:{display:"flex",flexDirection:"column",gap:2.5},children:[e.jsxs(M,{label:"Artikelstatus",value:he,onChange:l=>ue(l.target.value),select:!0,fullWidth:!0,helperText:"Entwürfe sind nur für dich sichtbar",children:[e.jsx(F,{value:"draft",children:"Entwurf"}),e.jsx(F,{value:"published",children:"Veröffentlicht"}),e.jsx(F,{value:"sold",children:"Verkauft"})]}),e.jsx(I,{variant:"outlined",color:"error",onClick:()=>H(!0),startIcon:e.jsx(Oe,{size:20}),fullWidth:r,sx:{alignSelf:r?"stretch":"flex-start"},children:"Artikel löschen"})]})]})]}),e.jsxs(a,{sx:{mt:4,display:"flex",gap:2,justifyContent:"flex-end",flexWrap:"wrap"},children:[e.jsx(I,{variant:"outlined",onClick:()=>d(`/item/${o}`),startIcon:e.jsx(ws,{size:20}),disabled:C,fullWidth:r,children:"Abbrechen"}),e.jsx(I,{variant:"contained",onClick:as,disabled:C||!D.trim()||!y.trim()||!_,startIcon:C?e.jsx(se,{size:20,color:"inherit"}):e.jsx(Bs,{size:20}),fullWidth:r,children:C?"Speichern...":"Änderungen speichern"})]})]})]}),e.jsxs(Ds,{open:Ye,onClose:()=>H(!1),maxWidth:"xs",fullWidth:!0,children:[e.jsx(ks,{children:"Artikel löschen?"}),e.jsx(Is,{children:e.jsx(qs,{children:"Möchtest du diesen Artikel wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden."})}),e.jsxs(As,{children:[e.jsx(I,{onClick:()=>H(!1),disabled:R,children:"Abbrechen"}),e.jsx(I,{onClick:ns,color:"error",variant:"contained",disabled:R,startIcon:R?e.jsx(se,{size:20,color:"inherit"}):e.jsx(Oe,{size:20}),children:R?"Lösche...":"Löschen"})]})]})]})};export{Qs as ItemEditPage};
