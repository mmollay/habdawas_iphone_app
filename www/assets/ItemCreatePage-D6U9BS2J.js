import{r as o,G as D,j as e,T as i,B as n,a2 as F,a9 as At,ae as st,at as Oi,ac as Ht,ah as Se,ao as Ge,ap as Zt,au as Xt,av as Jt,ar as be,n as ot,J as Ve,aw as Qt,I as Oe,w as Ce,ax as Ai,y as Ie,R as Hi,H as Zi,ay as Xi,az as Ji,aA as Qi,f as Yi,h as Ti,a3 as Ui,O as Pe,F as Yt,X as Tt,aB as er,aC as tr,af as ir,aD as rr,aE as nr,a0 as nt,ai as Ut,K as sr,aF as ei,am as or}from"./index-DGPOwJJr.js";import{C as ti,M as ii,L as ar,B as lr,D as cr}from"./MultiImageUpload-CcYahZ3B.js";import{A as at,a as lt,b as ct}from"./AccordionSummary-DTGT1Hvj.js";import{P as ri}from"./phone-LmM7JZ8B.js";import{C as ni,X as dr}from"./x-circle-CmvsgzW0.js";import{C as Be}from"./chevron-down-D3Id4EJ6.js";import{C as Ae}from"./Collapse-Dmhu021x.js";import{G as te}from"./Grid-CZGgcgxd.js";import{a as hr,S as ur}from"./star-CCnGXB6K.js";import"./CategoryDropdown-C5_L9UJB.js";import"./Search-B8gagK-N.js";import"./alert-circle-BIXLrZ7T.js";import"./leaf-BMOzByc0.js";const mr=()=>{const[M,j]=o.useState(null),[r,x]=o.useState(!0);o.useEffect(()=>{de()},[]);const de=async()=>{try{const{data:P,error:V}=await D.from("token_conversion_settings").select("setting_key, setting_value");if(V)throw V;const O={geminiTokensPerCredit:250,manualListingCost:0,minCreditsForAI:1};P==null||P.forEach(A=>{const l=parseInt(A.setting_value);A.setting_key==="gemini_tokens_per_credit"?O.geminiTokensPerCredit=l:A.setting_key==="manual_listing_cost"?O.manualListingCost=l:A.setting_key==="min_credits_for_ai"&&(O.minCreditsForAI=l)}),j(O)}catch(P){console.error("Error fetching token conversion settings:",P),j({geminiTokensPerCredit:250,manualListingCost:0,minCreditsForAI:1})}finally{x(!1)}},he=o.useCallback(P=>{if(!M)return{geminiTokens:0,estimatedCredits:0,isFree:!0};if(P===0)return{geminiTokens:0,estimatedCredits:M.manualListingCost,isFree:M.manualListingCost===0};const V=Math.ceil(P/M.geminiTokensPerCredit),O=Math.max(V,M.minCreditsForAI);return{geminiTokens:P,estimatedCredits:O,isFree:!1}},[M]),ie=o.useCallback(async(P,V,O,A,l)=>{try{const{data:y,error:K}=await D.rpc("deduct_credits_for_ai",{p_user_id:P,p_item_id:V,p_gemini_input_tokens:O,p_gemini_output_tokens:A,p_description:l});if(K)throw K;const H=(y==null?void 0:y[0])||y;if(!H)throw new Error("No result from deduct_credits_for_ai function");return{success:H.success,newBalance:H.new_balance,creditsUsed:H.credits_used,error:H.error_message||void 0}}catch(y){return console.error("Error deducting credits:",y),{success:!1,newBalance:0,creditsUsed:0,error:y instanceof Error?y.message:"Failed to deduct credits"}}},[]);return{settings:M,loading:r,calculateCreditsFromTokens:he,deductCreditsForAI:ie,refetch:de}},gr=({pickupAddress:M,shippingEnabled:j,shippingCostType:r,shippingCostFixed:x,shippingDescription:de,priceNegotiable:he,isFree:ie,duration:P,onShippingEnabledChange:V,onShippingCostTypeChange:O,onShippingCostFixedChange:A,onShippingDescriptionChange:l,onPriceNegotiableChange:y,onIsFreeChange:K,onDurationChange:H,pickupEnabled:Q,onPickupEnabledChange:ve,phoneVisible:ue=!1})=>{const He=()=>j?r==="free"?"Kostenlos":r==="fixed"?`€${x.toFixed(2)}`:"KI-berechnet":"Nicht verfügbar";return e.jsxs(at,{sx:{mt:2.5,border:"1px solid",borderColor:"divider",borderRadius:2,"&:before":{display:"none"},boxShadow:"none"},children:[e.jsxs(lt,{expandIcon:e.jsx(Be,{size:20}),sx:{"& .MuiAccordionSummary-content":{display:"flex",flexDirection:"column",gap:1.5}},children:[e.jsx(i,{variant:"subtitle2",sx:{fontWeight:600,mb:.5},children:"Artikel-Einstellungen"}),e.jsxs(n,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[Q&&e.jsx(F,{icon:e.jsx(At,{size:14}),label:M?`Abholung: ${M}`:"Abholung möglich",size:"small",sx:{fontSize:"0.75rem"}}),Q&&ue&&e.jsx(F,{icon:e.jsx(ri,{size:14}),label:"Tel. sichtbar",size:"small",color:"info",sx:{fontSize:"0.75rem"}}),e.jsx(F,{icon:e.jsx(st,{size:14}),label:`Versand: ${He()}`,size:"small",color:j?"primary":"default",sx:{fontSize:"0.75rem"}}),ie&&e.jsx(F,{icon:e.jsx(Oi,{size:14}),label:"Zu verschenken",size:"small",color:"success",sx:{fontSize:"0.75rem"}}),!ie&&he&&e.jsx(F,{icon:e.jsx(Ht,{size:14}),label:"VB",size:"small",sx:{fontSize:"0.75rem",fontWeight:700,bgcolor:"warning.main",color:"white"}}),e.jsx(F,{icon:e.jsx(ni,{size:14}),label:`${P} Tage`,size:"small",sx:{fontSize:"0.75rem"}})]})]}),e.jsx(ct,{sx:{pt:1.75,borderTop:"1px solid",borderColor:"divider"},children:e.jsxs(n,{sx:{display:"flex",flexDirection:"column",gap:2.5},children:[e.jsxs(n,{children:[e.jsxs(i,{variant:"subtitle2",sx:{fontWeight:600,mb:1.5,display:"flex",alignItems:"center",gap:1},children:[e.jsx(At,{size:16}),"Abholung"]}),e.jsx(Se,{control:e.jsx(Ge,{checked:Q,onChange:W=>ve(W.target.checked),size:"small"}),label:"Abholung aktivieren"}),Q&&e.jsxs(n,{sx:{mt:1,ml:4},children:[e.jsxs(i,{variant:"caption",color:"text.secondary",sx:{display:"block"},children:["📍 ",M||"Keine Adresse ausgewählt"]}),ue&&e.jsxs(i,{variant:"caption",color:"info.main",sx:{display:"flex",alignItems:"center",gap:.5,mt:.5},children:[e.jsx(ri,{size:12})," Telefonnummer wird im Inserat angezeigt"]}),!ue&&M&&e.jsx(i,{variant:"caption",color:"text.secondary",sx:{display:"block",mt:.5},children:"🔒 Telefonnummer wird nicht angezeigt"})]})]}),e.jsxs(n,{children:[e.jsxs(i,{variant:"subtitle2",sx:{fontWeight:600,mb:1.5,display:"flex",alignItems:"center",gap:1},children:[e.jsx(st,{size:16}),"Versand"]}),e.jsx(Se,{control:e.jsx(Ge,{checked:j,onChange:W=>V(W.target.checked),size:"small"}),label:"Versand aktivieren",sx:{mb:1.5}}),j&&e.jsxs(n,{sx:{ml:4,display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(Zt,{fullWidth:!0,size:"small",children:[e.jsx(Xt,{children:"Versandkosten"}),e.jsxs(Jt,{value:r,label:"Versandkosten",onChange:W=>O(W.target.value),children:[e.jsx(be,{value:"ai_calculated",children:"KI-berechnet"}),e.jsx(be,{value:"fixed",children:"Festpreis"}),e.jsx(be,{value:"free",children:"Kostenlos"})]})]}),(r==="fixed"||r==="ai_calculated")&&e.jsx(ot,{fullWidth:!0,size:"small",type:"number",label:r==="ai_calculated"?"Versandkosten (€) - Manuell festlegen":"Versandkosten (€)",value:x,onChange:W=>A(Number(W.target.value)),inputProps:{min:0,step:.5},helperText:r==="ai_calculated"?"Im manuellen Modus wird keine KI-Berechnung durchgeführt":void 0}),l&&e.jsx(ot,{fullWidth:!0,size:"small",multiline:!0,rows:2,label:"Versandinformationen (optional)",value:de||"",onChange:W=>l(W.target.value),placeholder:"z.B. Versand mit DHL, 1-3 Werktage"})]})]}),e.jsxs(n,{children:[e.jsxs(i,{variant:"subtitle2",sx:{fontWeight:600,mb:1.5,display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ht,{size:16}),"Preis"]}),e.jsxs(n,{sx:{display:"flex",flexDirection:"column",gap:1.5},children:[e.jsx(Se,{control:e.jsx(Ge,{checked:ie,onChange:W=>{K(W.target.checked),W.target.checked&&y(!1)},size:"small"}),label:e.jsxs(n,{children:[e.jsx(i,{variant:"body2",children:"Zu verschenken"}),e.jsx(i,{variant:"caption",color:"text.secondary",children:"Artikel kostenlos abgeben"})]})}),!ie&&e.jsx(Se,{control:e.jsx(Ge,{checked:he,onChange:W=>y(W.target.checked),size:"small"}),label:e.jsxs(n,{children:[e.jsx(i,{variant:"body2",children:"Verhandlungsbasis (VB)"}),e.jsx(i,{variant:"caption",color:"text.secondary",children:"Preis ist verhandelbar"})]})})]})]}),e.jsxs(n,{children:[e.jsxs(i,{variant:"subtitle2",sx:{fontWeight:600,mb:1.5,display:"flex",alignItems:"center",gap:1},children:[e.jsx(ni,{size:16}),"Laufzeit"]}),e.jsxs(Zt,{fullWidth:!0,size:"small",children:[e.jsx(Xt,{children:"Anzeigedauer"}),e.jsxs(Jt,{value:P,label:"Anzeigedauer",onChange:W=>H(Number(W.target.value)),children:[e.jsx(be,{value:7,children:"7 Tage"}),e.jsx(be,{value:14,children:"14 Tage"}),e.jsx(be,{value:30,children:"30 Tage"}),e.jsx(be,{value:60,children:"60 Tage"}),e.jsx(be,{value:90,children:"90 Tage"})]})]}),e.jsx(i,{variant:"caption",color:"text.secondary",sx:{display:"block",mt:1},children:"Das Inserat wird nach Ablauf automatisch deaktiviert"})]})]})})]})},pr=({analyses:M,scoredAnalyses:j,mergedAnalysis:r,categoryInfo:x,onConfirm:de,onCancel:he})=>{var A;const[ie,P]=o.useState(null),[V,O]=o.useState(!0);return j[0],e.jsxs(n,{sx:{p:3},children:[e.jsx(i,{variant:"h5",gutterBottom:!0,children:"🤖 AI-Analyse Ergebnisse"}),e.jsxs(i,{variant:"body2",color:"text.secondary",sx:{mb:3},children:[M.length," Bilder analysiert - Überprüfe die Ergebnisse vor dem Speichern"]}),e.jsxs(Ve,{sx:{p:2,mb:3,bgcolor:"success.50",border:"2px solid",borderColor:"success.main"},children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2},children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Qt,{size:24,color:"green"}),e.jsx(i,{variant:"h6",children:"Finales Ergebnis (wird gespeichert)"})]}),e.jsx(Oe,{onClick:()=>O(!V),size:"small",children:V?e.jsx(ti,{}):e.jsx(Be,{})})]}),e.jsx(Ae,{in:V,children:e.jsxs(te,{container:!0,spacing:2,children:[e.jsxs(te,{item:!0,xs:12,children:[e.jsx(i,{variant:"subtitle2",color:"text.secondary",children:"Titel"}),e.jsx(i,{variant:"h6",children:r.title})]}),e.jsxs(te,{item:!0,xs:12,sm:6,children:[e.jsx(i,{variant:"subtitle2",color:"text.secondary",children:"Preis"}),e.jsxs(i,{variant:"h6",children:["€ ",r.price]})]}),e.jsxs(te,{item:!0,xs:12,sm:6,children:[e.jsx(i,{variant:"subtitle2",color:"text.secondary",children:"Kategorie"}),e.jsxs(n,{sx:{display:"flex",gap:.5,flexWrap:"wrap"},children:[(x==null?void 0:x.level1)&&e.jsx(F,{label:x.level1,size:"small",color:"primary"}),(x==null?void 0:x.level2)&&e.jsx(F,{label:x.level2,size:"small",color:"primary",variant:"outlined"}),(x==null?void 0:x.level3)&&e.jsx(F,{label:x.level3,size:"small"})]})]}),e.jsxs(te,{item:!0,xs:12,children:[e.jsx(i,{variant:"subtitle2",color:"text.secondary",children:"Beschreibung"}),e.jsx(i,{variant:"body2",sx:{whiteSpace:"pre-line",maxHeight:200,overflow:"auto"},children:r.description})]}),(r.brand||r.condition||((A=r.features)==null?void 0:A.length)>0)&&e.jsxs(te,{item:!0,xs:12,children:[e.jsx(Ce,{sx:{my:1.5}}),e.jsx(i,{variant:"subtitle1",sx:{fontWeight:600,mb:1.5},children:"📋 Attribute"}),e.jsxs(n,{sx:{display:"flex",flexDirection:"column",gap:1.25},children:[r.brand&&e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(i,{variant:"caption",color:"text.secondary",sx:{minWidth:"120px",fontWeight:600},children:"Marke:"}),e.jsx(i,{variant:"body2",fontWeight:500,children:r.brand})]}),r.condition&&e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(i,{variant:"caption",color:"text.secondary",sx:{minWidth:"120px",fontWeight:600},children:"Zustand:"}),e.jsx(i,{variant:"body2",fontWeight:500,children:r.condition})]}),r.features&&r.features.length>0&&e.jsxs(n,{sx:{display:"flex",alignItems:"flex-start",gap:1.5},children:[e.jsx(i,{variant:"caption",color:"text.secondary",sx:{minWidth:"120px",fontWeight:600,pt:.5},children:"Features:"}),e.jsx(n,{sx:{display:"flex",gap:.5,flexWrap:"wrap",flex:1},children:r.features.map((l,y)=>e.jsx(F,{label:l,size:"small",variant:"outlined"},y))})]})]})]}),r.colors&&r.colors.length>0&&e.jsxs(te,{item:!0,xs:12,children:[e.jsx(Ce,{sx:{my:1.5}}),e.jsx(i,{variant:"subtitle2",color:"text.secondary",sx:{mb:1,fontWeight:600},children:"🎨 Farben"}),e.jsx(n,{sx:{display:"flex",gap:.75,flexWrap:"wrap"},children:r.colors.map((l,y)=>e.jsx(F,{label:l,size:"small"},y))})]}),(r.vehicle_brand||r.vehicle_year||r.vehicle_mileage||r.vehicle_fuel_type||r.vehicle_power_kw||r.vehicle_first_registration||r.vehicle_tuv_until||r.vehicle_color)&&e.jsxs(te,{item:!0,xs:12,children:[e.jsx(Ce,{sx:{my:1.5}}),e.jsx(i,{variant:"subtitle1",sx:{fontWeight:600,mb:1.5},children:"🚗 Fahrzeug-Attribute"}),e.jsxs(n,{sx:{display:"flex",flexDirection:"column",gap:1.25},children:[r.vehicle_brand&&e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(i,{variant:"caption",color:"text.secondary",sx:{minWidth:"120px",fontWeight:600},children:"Marke:"}),e.jsx(i,{variant:"body2",fontWeight:500,children:r.vehicle_brand})]}),r.vehicle_year&&e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(i,{variant:"caption",color:"text.secondary",sx:{minWidth:"120px",fontWeight:600},children:"Baujahr:"}),e.jsx(i,{variant:"body2",fontWeight:500,children:r.vehicle_year})]}),r.vehicle_mileage&&e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(i,{variant:"caption",color:"text.secondary",sx:{minWidth:"120px",fontWeight:600},children:"Kilometerstand:"}),e.jsxs(i,{variant:"body2",fontWeight:500,children:[r.vehicle_mileage.toLocaleString()," km"]})]}),r.vehicle_fuel_type&&e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(i,{variant:"caption",color:"text.secondary",sx:{minWidth:"120px",fontWeight:600},children:"Kraftstoff:"}),e.jsx(i,{variant:"body2",fontWeight:500,children:r.vehicle_fuel_type})]}),r.vehicle_power_kw&&e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(i,{variant:"caption",color:"text.secondary",sx:{minWidth:"120px",fontWeight:600},children:"Leistung:"}),e.jsxs(i,{variant:"body2",fontWeight:500,children:[r.vehicle_power_kw," kW (",Math.round(r.vehicle_power_kw*1.36)," PS)"]})]}),r.vehicle_first_registration&&e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(i,{variant:"caption",color:"text.secondary",sx:{minWidth:"120px",fontWeight:600},children:"Erstzulassung:"}),e.jsx(i,{variant:"body2",fontWeight:500,children:r.vehicle_first_registration})]}),r.vehicle_tuv_until&&e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(i,{variant:"caption",color:"text.secondary",sx:{minWidth:"120px",fontWeight:600},children:"TÜV bis:"}),e.jsx(i,{variant:"body2",fontWeight:500,children:r.vehicle_tuv_until})]}),r.vehicle_color&&e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(i,{variant:"caption",color:"text.secondary",sx:{minWidth:"120px",fontWeight:600},children:"Fahrzeugfarbe:"}),e.jsx(i,{variant:"body2",fontWeight:500,children:r.vehicle_color})]})]})]}),(r.size||r.weight||r.dimensions||r.material||r.style||r.serialNumber)&&e.jsxs(te,{item:!0,xs:12,children:[e.jsx(Ce,{sx:{my:1.5}}),e.jsx(i,{variant:"subtitle1",sx:{fontWeight:600,mb:1.5},children:"📐 Physische Eigenschaften"}),e.jsxs(n,{sx:{display:"flex",flexDirection:"column",gap:1.25},children:[r.size&&e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(i,{variant:"caption",color:"text.secondary",sx:{minWidth:"120px",fontWeight:600},children:"Größe:"}),e.jsx(i,{variant:"body2",fontWeight:500,children:r.size})]}),r.weight&&e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(i,{variant:"caption",color:"text.secondary",sx:{minWidth:"120px",fontWeight:600},children:"Gewicht:"}),e.jsx(i,{variant:"body2",fontWeight:500,children:r.weight})]}),r.dimensions&&e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(i,{variant:"caption",color:"text.secondary",sx:{minWidth:"120px",fontWeight:600},children:"Abmessungen (L × B × H):"}),e.jsx(i,{variant:"body2",fontWeight:500,children:[r.dimensions.length,r.dimensions.width,r.dimensions.height].filter(Boolean).join(" × ")})]}),r.material&&e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(i,{variant:"caption",color:"text.secondary",sx:{minWidth:"120px",fontWeight:600},children:"Material:"}),e.jsx(i,{variant:"body2",fontWeight:500,children:r.material})]}),r.style&&e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(i,{variant:"caption",color:"text.secondary",sx:{minWidth:"120px",fontWeight:600},children:"Stil:"}),e.jsx(i,{variant:"body2",fontWeight:500,children:r.style})]}),r.serialNumber&&e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(i,{variant:"caption",color:"text.secondary",sx:{minWidth:"120px",fontWeight:600},children:"Seriennummer:"}),e.jsx(i,{variant:"body2",fontWeight:500,sx:{fontFamily:"monospace"},children:r.serialNumber})]})]})]}),r.tags&&r.tags.length>0&&e.jsxs(te,{item:!0,xs:12,children:[e.jsx(Ce,{sx:{my:1}}),e.jsxs(i,{variant:"subtitle2",color:"text.secondary",children:["Tags (",r.tags.length,")"]}),e.jsxs(n,{sx:{display:"flex",gap:.5,flexWrap:"wrap",maxHeight:100,overflow:"auto"},children:[r.tags.slice(0,15).map((l,y)=>e.jsx(F,{label:l,size:"small",variant:"outlined",color:"secondary"},y)),r.tags.length>15&&e.jsx(F,{label:`+${r.tags.length-15} mehr`,size:"small",variant:"outlined"})]})]})]})})]}),e.jsx(Ce,{sx:{my:3}}),e.jsx(i,{variant:"h6",gutterBottom:!0,children:"🎯 Analyse-Scores (Bild für Bild)"}),e.jsx(i,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Höchster Score = Beste Analyse (wird als Basis verwendet)"}),e.jsx(te,{container:!0,spacing:2,children:j.map((l,y)=>{var Q;const K=y===0,H=ie===y;return e.jsx(te,{item:!0,xs:12,children:e.jsx(Ai,{sx:{border:K?"2px solid":"1px solid",borderColor:K?"success.main":"divider",bgcolor:K?"success.50":"background.paper"},children:e.jsxs(n,{sx:{p:2},children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:1},children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1},children:[K&&e.jsx(hr,{size:20,fill:"gold",color:"gold"}),e.jsxs(i,{variant:"subtitle1",fontWeight:K?700:400,children:["Bild ",l.index+1,": ",l.analysis.title.substring(0,50),"..."]})]}),e.jsx(Oe,{onClick:()=>P(H?null:y),size:"small",children:H?e.jsx(ti,{}):e.jsx(Be,{})})]}),e.jsxs(n,{sx:{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap"},children:[e.jsx(F,{label:`Score: ${l.score}`,size:"small",color:K?"success":"default",variant:K?"filled":"outlined"}),e.jsx(F,{label:`€ ${l.analysis.price}`,size:"small",variant:"outlined"}),l.isDocument&&e.jsx(F,{label:"📄 Dokument",size:"small",color:"warning",variant:"outlined"}),l.analysis.brand&&e.jsx(F,{label:l.analysis.brand,size:"small",variant:"outlined"})]}),e.jsx(Ae,{in:H,children:e.jsxs(n,{sx:{mt:2,pt:2,borderTop:"1px solid",borderColor:"divider"},children:[e.jsx(i,{variant:"body2",sx:{mb:1},children:e.jsx("strong",{children:"Beschreibung:"})}),e.jsxs(i,{variant:"body2",color:"text.secondary",sx:{whiteSpace:"pre-line",mb:2},children:[(Q=l.analysis.description)==null?void 0:Q.substring(0,300),l.analysis.description&&l.analysis.description.length>300?"...":""]}),l.analysis.features&&l.analysis.features.length>0&&e.jsxs(n,{sx:{mb:1},children:[e.jsx(i,{variant:"body2",children:e.jsx("strong",{children:"Features:"})}),e.jsx(n,{sx:{display:"flex",gap:.5,flexWrap:"wrap",mt:.5},children:l.analysis.features.map((ve,ue)=>e.jsx(F,{label:ve,size:"small",variant:"outlined"},ue))})]})]})})]})})},y)})}),e.jsxs(n,{sx:{mt:4,display:"flex",gap:2,justifyContent:"flex-end"},children:[e.jsx(Ie,{variant:"outlined",size:"large",startIcon:e.jsx(dr,{}),onClick:he,children:"Abbrechen"}),e.jsx(Ie,{variant:"contained",size:"large",startIcon:e.jsx(Qt,{}),onClick:de,color:"success",children:"Bestätigen & Speichern"})]})]})},Er=()=>{const M=Hi(),{user:j}=Zi(),{isDeveloperMode:r}=Xi(),{personalCredits:x}=Ji(),{checkCredit:de,consumeCredit:he}=Qi(),{calculateCreditsFromTokens:ie,deductCreditsForAI:P,settings:V}=mr(),O=Yi(),A=Ti(O.breakpoints.down("sm")),[l,y]=o.useState([]),[K,H]=o.useState("upload"),[Q,ve]=o.useState(!1),[ue,He]=o.useState(""),[W,dt]=o.useState(!1),[Ze,ht]=o.useState(!1),[ut,si]=o.useState(!1),[Xe,mt]=o.useState(30),[_e,gt]=o.useState(!1),[Je,pt]=o.useState(!1),[We,oi]=o.useState(null),[ft,ke]=o.useState(""),[bt,kt]=o.useState(0),[Ke,ai]=o.useState([]),[Le,li]=o.useState(""),[we,ci]=o.useState(null),[xt,vt]=o.useState(!1),[di,hi]=o.useState(!1),[ui,mi]=o.useState(!0),[Qe,_t]=o.useState(""),[Ye,wt]=o.useState(""),[Te,yt]=o.useState(""),[zt,jt]=o.useState(void 0),[gi,pi]=o.useState(""),[fi,bi]=o.useState(""),[ki,xi]=o.useState([]),[Ne,vi]=o.useState({sustainability:[],condition:[],seller_type:[]}),[Ct,Ue]=o.useState(!1),[ye,St]=o.useState(null),[_i,wi]=o.useState(""),[yi,zi]=o.useState(""),[ji,Ci]=o.useState(""),[Si,Ii]=o.useState(""),[Wi,Li]=o.useState(""),[Ei,Di]=o.useState(""),[Fi,Mi]=o.useState([]),[Pi,Bi]=o.useState(""),[Ki,Ni]=o.useState(""),[It,Wt]=o.useState(!1),[Lt,Et]=o.useState("free"),[Dt,Ft]=o.useState(0),[Mt,Pt]=o.useState(""),[Bt,Kt]=o.useState(!1),[qi,$i]=o.useState(!1),[fr,Ri]=o.useState("");o.useEffect(()=>{if(!j){M("/");return}(async()=>{try{const[v,u,U]=await Promise.all([D.from("addresses").select("*").eq("user_id",j.id).order("is_default_shipping",{ascending:!1}),D.from("profiles").select("shipping_enabled, shipping_cost, shipping_cost_type, shipping_description, pickup_enabled, show_location_publicly, location_description, ai_analyze_all_images").eq("id",j.id).maybeSingle(),D.from("items").select("id",{count:"exact",head:!0}).eq("user_id",j.id)]);if(v.data){ai(v.data);const ae=v.data.filter(R=>R.address_type==="pickup_only"||R.address_type==="both"),re=ae.find(R=>R.is_default_shipping)||ae[0];re&&li(re.id)}u.data&&(ci(u.data),u.data.shipping_enabled&&Wt(u.data.shipping_enabled),u.data.shipping_cost_type&&Et(u.data.shipping_cost_type),u.data.shipping_cost&&Ft(u.data.shipping_cost),u.data.shipping_description&&Pt(u.data.shipping_description),u.data.pickup_enabled&&Kt(u.data.pickup_enabled),u.data.show_location_publicly!==void 0&&$i(u.data.show_location_publicly),u.data.location_description&&Ri(u.data.location_description));const ce=(U.count||0)===0;hi(ce),vt(ce)}catch(v){console.error("Error loading data:",v)}})()},[j,M]),o.useEffect(()=>{l.length>0&&K==="upload"&&H("choose")},[l,K]),o.useEffect(()=>{var d;if(V&&We){const v=((d=We.tokenUsage)==null?void 0:d.totalTokens)||0,u=ie(v);kt(u.estimatedCredits)}else kt(0)},[We,V,ie]);const Gi=async(d,v,u)=>{const{data:{session:U}}=await D.auth.getSession(),Y=U==null?void 0:U.access_token;if(!Y)throw new Error("Keine Authentifizierung vorhanden");const ae={Deutschland:"DE",Österreich:"AT",Schweiz:"CH",Frankreich:"FR",Italien:"IT",Spanien:"ES",Niederlande:"NL",Belgien:"BE",Polen:"PL",Tschechien:"CZ"}[v]||"DE",re=await fetch("https://hsbjflixgavjqxvnkivi.supabase.co/functions/v1/analyze-image",{method:"POST",headers:{Authorization:`Bearer ${Y}`,"Content-Type":"application/json"},body:JSON.stringify({imageData:d,shippingCountry:ae,additionalNotes:u})}),R=await re.json();if(!re.ok)throw R.insufficientTokens?new Error(`Nicht genügend Tokens. Du hast ${R.currentBalance} Tokens, benötigt wird ${R.required}.`):new Error(R.error||"Analyse fehlgeschlagen");return R},Nt=async()=>{var d,v,u,U,Y,ce,ae,re,R,Ee,ne,z,tt,qe,$e,t,me,ge,pe,N,De,Fe,m,ze,c,g,p,_,T,b,le,L,ee,B,Z,X,fe,qt,$t,Rt,Gt;if(!(l.length===0||!j)){gt(!0),ke("");try{console.log("Starting AI analysis...");const xe=Ke.find(s=>s.id===Le),Vi=(xe==null?void 0:xe.country)||ei(),Vt=(we==null?void 0:we.ai_analyze_all_images)??!1?l:[l.find(s=>s.isPrimary)||l[0]];console.log("Analyzing images:",Vt.length);const Me=await Promise.all(Vt.map(s=>Gi(s.preview,Vi,ue)));console.log("Analysis complete:",Me);const it=["schein","dokument","papier","zertifikat","urkunde","bescheinigung","brief"],Re=Me.map((s,E)=>{var h,G;let S=0;const je=s.title.toLowerCase();return it.some(w=>je.includes(w))&&(S-=1e3),S+=s.price,S+=(((h=s.description)==null?void 0:h.length)||0)/10,s.brand&&s.brand.length>0&&(S+=100),S+=(((G=s.features)==null?void 0:G.length)||0)*10,E===0&&(S+=1),{analysis:s,score:S,index:E}});Re.sort((s,E)=>E.score-s.score);const Ot=Re[0].analysis;console.log("🎯 Multi-image analysis scores:",Re.map(s=>({title:s.analysis.title.substring(0,40),score:s.score,price:s.analysis.price,isDocument:it.some(E=>s.analysis.title.toLowerCase().includes(E))})));const a={...Ot},rt=[];if(Me.length>1&&Me.forEach(s=>{if(s===Ot)return;if(s.features&&(a.features=[...new Set([...a.features||[],...s.features])]),s.colors&&(a.colors=[...new Set([...a.colors||[],...s.colors])]),s.accessories&&(a.accessories=[...new Set([...a.accessories||[],...s.accessories])]),s.tags&&(a.tags=[...new Set([...a.tags||[],...s.tags])]),s.vehicle_brand&&!a.vehicle_brand&&(a.vehicle_brand=s.vehicle_brand),s.vehicle_year&&!a.vehicle_year&&(a.vehicle_year=s.vehicle_year),s.vehicle_mileage&&!a.vehicle_mileage&&(a.vehicle_mileage=s.vehicle_mileage),s.vehicle_fuel_type&&!a.vehicle_fuel_type&&(a.vehicle_fuel_type=s.vehicle_fuel_type),s.vehicle_color&&!a.vehicle_color&&(a.vehicle_color=s.vehicle_color),s.vehicle_power_kw&&!a.vehicle_power_kw&&(a.vehicle_power_kw=s.vehicle_power_kw),s.vehicle_first_registration&&!a.vehicle_first_registration&&(a.vehicle_first_registration=s.vehicle_first_registration),s.vehicle_tuv_until&&!a.vehicle_tuv_until&&(a.vehicle_tuv_until=s.vehicle_tuv_until),it.some(S=>s.title.toLowerCase().includes(S))&&s.description){const je=s.description.split(`
`).filter(C=>C.trim()).filter(C=>C.includes(":")||C.match(/\d{4}/)||C.match(/\d+\s*km/)||C.toLowerCase().includes("tüv")||C.toLowerCase().includes("erstzulassung")||C.toLowerCase().includes("baujahr"));je.length>0&&rt.push(...je)}}),rt.length>0){const s=`

📋 Technische Daten:
`+rt.map(E=>`• ${E.trim()}`).join(`
`);a.description+=s}oi(a),_t(a.title),wt(a.description),yt(a.price.toString());let se=a.category_id,f={};if(!se&&a.category){console.log("🔍 Mapping AI text categories to hierarchical system:",{category:a.category,subcategory:a.subcategory});const s={geschirr:["küche","esszimmer"],teller:["küche","esszimmer"],besteck:["küche","esszimmer"],messer:["küche","esszimmer"],gabel:["küche","esszimmer"],tassen:["küche","esszimmer"],gläser:["küche","esszimmer"],kochgeschirr:["küche","esszimmer"],töpfe:["küche","esszimmer"],pfannen:["küche","esszimmer"],küchengeräte:["küche","elektronik"],mixer:["küche","elektronik"],kaffeemaschine:["küche","elektronik"],toaster:["küche","elektronik"],mikrowelle:["küche","elektronik"],sofa:["wohnzimmer","wohnen","möbel"],couch:["wohnzimmer","wohnen","möbel"],sessel:["wohnzimmer","wohnen","möbel"],tisch:["wohnzimmer","esszimmer","möbel"],stuhl:["wohnzimmer","esszimmer","möbel"],regal:["wohnzimmer","büro","möbel"],schrank:["schlafzimmer","möbel"],kleiderschrank:["schlafzimmer","möbel"],bett:["schlafzimmer","möbel"],matratze:["schlafzimmer","möbel"],kommode:["schlafzimmer","möbel"],lampe:["beleuchtung","deko"],deckenlampe:["beleuchtung","deko"],stehlampe:["beleuchtung","deko"],tischlampe:["beleuchtung","deko"],vase:["deko","wohnen"],bilderrahmen:["deko","wohnen"],kerze:["deko","wohnen"],teppich:["teppiche","wohnen"],vorhang:["gardinen","wohnen"],gardine:["gardinen","wohnen"],auto:["autos","fahrzeuge"],pkw:["autos","fahrzeuge"],kleinwagen:["autos","fahrzeuge"],limousine:["autos","fahrzeuge"],kombi:["autos","fahrzeuge"],suv:["autos","fahrzeuge"],geländewagen:["autos","fahrzeuge"],sportwagen:["autos","fahrzeuge"],cabrio:["autos","fahrzeuge"],van:["autos","fahrzeuge"],motorrad:["motorräder","roller","fahrzeuge"],motorbike:["motorräder","roller","fahrzeuge"],roller:["motorräder","roller","fahrzeuge"],moped:["motorräder","roller","fahrzeuge"],quad:["motorräder","roller","fahrzeuge"],transporter:["nutzfahrzeuge","fahrzeuge"],lkw:["nutzfahrzeuge","fahrzeuge"],anhänger:["nutzfahrzeuge","fahrzeuge"],reifen:["ersatzteile","zubehör","fahrzeuge"],felgen:["ersatzteile","zubehör","fahrzeuge"],autoteile:["ersatzteile","zubehör","fahrzeuge"],tuning:["ersatzteile","zubehör","fahrzeuge"],boot:["boote","wasserfahrzeuge","fahrzeuge"],motorboot:["boote","wasserfahrzeuge","fahrzeuge"],segelboot:["boote","wasserfahrzeuge","fahrzeuge"],fahrrad:["fahrräder","e-bikes","fahrzeuge"],bike:["fahrräder","e-bikes","fahrzeuge"],mountainbike:["fahrräder","e-bikes","fahrzeuge"],rennrad:["fahrräder","e-bikes","fahrzeuge"],ebike:["fahrräder","e-bikes","fahrzeuge"],"e-bike":["fahrräder","e-bikes","fahrzeuge"],laptop:["computer","laptops","elektronik"],notebook:["computer","laptops","elektronik"],pc:["computer","laptops","elektronik"],desktop:["computer","laptops","elektronik"],monitor:["computer","laptops","elektronik"],bildschirm:["computer","laptops","elektronik"],tastatur:["computer","elektronik"],maus:["computer","elektronik"],drucker:["computer","elektronik"],scanner:["computer","elektronik"],smartphone:["smartphones","tablets","elektronik"],handy:["smartphones","tablets","elektronik"],iphone:["smartphones","tablets","elektronik"],android:["smartphones","tablets","elektronik"],tablet:["smartphones","tablets","elektronik"],ipad:["smartphones","tablets","elektronik"],fernseher:["tv","audio","video","elektronik"],tv:["tv","audio","video","elektronik"],"smart-tv":["tv","audio","video","elektronik"],heimkino:["tv","audio","video","elektronik"],soundbar:["tv","audio","video","elektronik"],lautsprecher:["tv","audio","video","elektronik"],kopfhörer:["tv","audio","video","elektronik"],headset:["tv","audio","video","elektronik"],kamera:["kameras","drohnen","elektronik"],digitalkamera:["kameras","drohnen","elektronik"],spiegelreflex:["kameras","drohnen","elektronik"],dslr:["kameras","drohnen","elektronik"],objektiv:["kameras","drohnen","elektronik"],drohne:["kameras","drohnen","elektronik"],"action-cam":["kameras","drohnen","elektronik"],gopro:["kameras","drohnen","elektronik"],konsole:["konsolen","games","elektronik"],playstation:["konsolen","games","elektronik"],ps4:["konsolen","games","elektronik"],ps5:["konsolen","games","elektronik"],xbox:["konsolen","games","elektronik"],nintendo:["konsolen","games","elektronik"],switch:["konsolen","games","elektronik"],videospiele:["konsolen","games","elektronik"],"smart-home":["smart-home","gadgets","elektronik"],alexa:["smart-home","gadgets","elektronik"],"google-home":["smart-home","gadgets","elektronik"],"fitness-tracker":["smart-home","gadgets","elektronik"],staubsauger:["haushalts-elektronik","elektronik"],"roboter-staubsauger":["haushalts-elektronik","elektronik"],bügeleisen:["haushalts-elektronik","elektronik"],kleidung:["damenmode","herrenmode","mode"],bekleidung:["damenmode","herrenmode","mode"],hose:["damenmode","herrenmode","mode"],jeans:["damenmode","herrenmode","mode"],shirt:["damenmode","herrenmode","mode"],"t-shirt":["damenmode","herrenmode","mode"],pullover:["damenmode","herrenmode","mode"],jacke:["damenmode","herrenmode","mode"],mantel:["damenmode","herrenmode","mode"],kleid:["damenmode","mode"],rock:["damenmode","mode"],bluse:["damenmode","mode"],anzug:["herrenmode","mode"],hemd:["herrenmode","mode"],sakko:["herrenmode","mode"],schuhe:["schuhe","mode"],sneaker:["schuhe","mode"],boots:["schuhe","mode"],stiefel:["schuhe","mode"],sandalen:["schuhe","mode"],damenschuhe:["schuhe","mode"],herrenschuhe:["schuhe","mode"],schmuck:["schmuck","uhren","mode"],uhr:["schmuck","uhren","mode"],armbanduhr:["schmuck","uhren","mode"],ring:["schmuck","uhren","mode"],kette:["schmuck","uhren","mode"],armband:["schmuck","uhren","mode"],ohrringe:["schmuck","uhren","mode"],tasche:["taschen","accessoires","mode"],handtasche:["taschen","accessoires","mode"],koffer:["taschen","accessoires","mode"],gürtel:["taschen","accessoires","mode"],sonnenbrille:["taschen","accessoires","mode"],beauty:["beauty","pflege","mode"],kosmetik:["beauty","pflege","mode"],parfum:["beauty","pflege","mode"],"make-up":["beauty","pflege","mode"],spielzeug:["spielzeug","kinder"],lego:["spielzeug","kinder"],puppe:["spielzeug","kinder"],kuscheltier:["spielzeug","kinder"],puzzle:["spielzeug","kinder"],brettspiel:["spielzeug","kinder"],babyartikel:["babyartikel","kinder"],babybett:["babyartikel","kinder"],kinderwagen:["kinderfahrzeuge","kinder"],buggy:["kinderfahrzeuge","kinder"],autositz:["kinderfahrzeuge","kinder"],kindersitz:["kinderfahrzeuge","kinder"],laufrad:["kinderfahrzeuge","kinder"],kinderkleidung:["kinderbekleidung","kinder"],babykleidung:["kinderbekleidung","kinder"],schulranzen:["schulbedarf","kinder"],schultasche:["schulbedarf","kinder"],kinderbuch:["kinderbücher","kinder"],bilderbuch:["kinderbücher","kinder"],hund:["hunde","tiere"],welpe:["hunde","tiere"],hundefutter:["hunde","tiere"],hundezubehör:["hunde","tiere"],leine:["hunde","tiere"],hundespielzeug:["hunde","tiere"],katze:["katzen","tiere"],kätzchen:["katzen","tiere"],kitten:["katzen","tiere"],katzenfutter:["katzen","tiere"],katzenzubehör:["katzen","tiere"],kratzbaum:["katzen","tiere"],pferd:["pferde","tiere"],pony:["pferde","tiere"],reitzubehör:["pferde","tiere"],sattel:["pferde","tiere"],reitbekleidung:["pferde","tiere"],kaninchen:["kleintiere","tiere"],meerschweinchen:["kleintiere","tiere"],hamster:["kleintiere","tiere"],vogel:["kleintiere","tiere"],käfig:["kleintiere","tiere"],aquarium:["aquaristik","terraristik","tiere"],fisch:["aquaristik","terraristik","tiere"],terrarium:["aquaristik","terraristik","tiere"],camping:["camping","outdoor","freizeit"],zelt:["camping","outdoor","freizeit"],schlafsack:["camping","outdoor","freizeit"],isomatte:["camping","outdoor","freizeit"],wandern:["camping","outdoor","freizeit"],rucksack:["camping","outdoor","freizeit"],fitness:["fitness","training","sport"],fitnessgerät:["fitness","training","sport"],hantel:["fitness","training","sport"],laufband:["fitness","training","sport"],hometrainer:["fitness","training","sport"],yoga:["fitness","training","sport"],yogamatte:["fitness","training","sport"],sportbekleidung:["fitness","training","sport"],musikinstrument:["musikinstrumente","freizeit"],gitarre:["musikinstrumente","freizeit"],"e-gitarre":["musikinstrumente","freizeit"],keyboard:["musikinstrumente","freizeit"],klavier:["musikinstrumente","freizeit"],schlagzeug:["musikinstrumente","freizeit"],dj:["musikinstrumente","freizeit"],modellbau:["modellbau","freizeit"],"rc-modell":["modellbau","freizeit"],modellbahn:["modellbau","freizeit"],buch:["bücher","comics","freizeit"],roman:["bücher","comics","freizeit"],sachbuch:["bücher","comics","freizeit"],kochbuch:["bücher","comics","freizeit"],comic:["bücher","comics","freizeit"],manga:["bücher","comics","freizeit"],hörbuch:["bücher","comics","freizeit"],sammeln:["sammeln","raritäten","freizeit"],münzen:["sammeln","raritäten","freizeit"],briefmarken:["sammeln","raritäten","freizeit"],sammelkarten:["sammeln","raritäten","freizeit"],haus:["häuser","immobilien"],einfamilienhaus:["häuser","immobilien"],doppelhaus:["häuser","immobilien"],reihenhaus:["häuser","immobilien"],villa:["häuser","immobilien"],wohnung:["wohnungen","immobilien"],eigentumswohnung:["wohnungen","immobilien"],mietwohnung:["miete","vermietung","immobilien"],zimmer:["miete","vermietung","immobilien"],grundstück:["grundstücke","immobilien"],baugrundstück:["grundstücke","immobilien"],ackerland:["grundstücke","immobilien"],gewerbe:["gewerbeimmobilien","immobilien"],büro:["gewerbeimmobilien","immobilien"],lager:["gewerbeimmobilien","immobilien"],traktor:["traktoren","landmaschinen","landwirtschaft"],mähdrescher:["traktoren","landmaschinen","landwirtschaft"],landmaschine:["traktoren","landmaschinen","landwirtschaft"],gabelstapler:["traktoren","landmaschinen","landwirtschaft"],motorsäge:["forst","gartenbedarf","landwirtschaft"],rasenmäher:["forst","gartenbedarf","landwirtschaft"],häcksler:["forst","gartenbedarf","landwirtschaft"],gewächshaus:["forst","gartenbedarf","landwirtschaft"],rinder:["nutztiere","landwirtschaft"],schweine:["nutztiere","landwirtschaft"],schafe:["nutztiere","landwirtschaft"],geflügel:["nutztiere","landwirtschaft"],bienen:["nutztiere","landwirtschaft"],saatgut:["saatgut","pflanzen","landwirtschaft"],pflanzen:["saatgut","pflanzen","landwirtschaft"],obstbaum:["saatgut","pflanzen","landwirtschaft"],zimmerpflanze:["saatgut","pflanzen","landwirtschaft"],brennholz:["brennholz","rohstoffe","landwirtschaft"],pellets:["brennholz","rohstoffe","landwirtschaft"],holz:["brennholz","rohstoffe","landwirtschaft"],werkzeug:["maschinen","werkzeuge","industrie"],werkzeugmaschine:["maschinen","werkzeuge","industrie"],bohrmaschine:["maschinen","werkzeuge","industrie"],säge:["maschinen","werkzeuge","industrie"],kompressor:["maschinen","werkzeuge","industrie"],generator:["maschinen","werkzeuge","industrie"],büromöbel:["büroeinrichtung","industrie"],schreibtisch:["büroeinrichtung","industrie"],bürostuhl:["büroeinrichtung","industrie"],aktenschrank:["büroeinrichtung","industrie"],gastronomie:["gastronomiebedarf","industrie"],kühlschrank:["gastronomiebedarf","industrie"],gastro:["gastronomiebedarf","industrie"],baumaterial:["baumaterial","industrie"],ziegel:["baumaterial","industrie"],zement:["baumaterial","industrie"],dämmstoffe:["baumaterial","industrie"],fenster:["baumaterial","industrie"],tür:["baumaterial","industrie"],kabel:["elektrotechnik","industrie"],leitungen:["elektrotechnik","industrie"],lagerregal:["lager","transport","industrie"],palette:["lager","transport","industrie"],europalette:["lager","transport","industrie"],software:["software","apps","digital"],windows:["software","apps","digital"],office:["software","apps","digital"],photoshop:["software","apps","digital"],app:["software","apps","digital"],antivirus:["software","apps","digital"],domain:["domains","webseiten","digital"],webseite:["domains","webseiten","digital"],website:["domains","webseiten","digital"],template:["domains","webseiten","digital"],nft:["nfts","digitale-kunst","digital"],"digitale-kunst":["nfts","digitale-kunst","digital"],"3d-modell":["nfts","digitale-kunst","digital"],stockfoto:["nfts","digitale-kunst","digital"],"online-kurs":["online-kurse","digital"],kurs:["online-kurse","digital"],webinar:["online-kurse","digital"],chatgpt:["ai-prompts","datenmodelle","digital"],midjourney:["ai-prompts","datenmodelle","digital"],"ai-prompt":["ai-prompts","datenmodelle","digital"],webentwicklung:["remote-dienstleistungen","digital"],grafikdesign:["remote-dienstleistungen","digital"],texterstellung:["remote-dienstleistungen","digital"],seo:["remote-dienstleistungen","digital"]},E={geschirr:["geschirr-besteck","geschirr"],teller:["geschirr-besteck","teller"],besteck:["geschirr-besteck","besteck"],messer:["geschirr-besteck","besteck"],gabel:["geschirr-besteck","besteck"],löffel:["geschirr-besteck","besteck"],tassen:["tassen-glaeser","tasse"],becher:["tassen-glaeser","tasse"],gläser:["tassen-glaeser","glas"],weinglas:["tassen-glaeser","glas"],töpfe:["toepfe-pfannen","topf"],pfannen:["toepfe-pfannen","pfanne"],kleinwagen:["kleinwagen","city"],"city-car":["kleinwagen","city"],limousine:["limousinen-kombis","limousine"],kombi:["limousinen-kombis","kombi"],suv:["suv-gelaendewagen","suv"],geländewagen:["suv-gelaendewagen","jeep"],sportwagen:["sportwagen-cabrios","sport"],cabrio:["sportwagen-cabrios","cabrio"],van:["vans-kleinbusse","van"],minivan:["vans-kleinbusse","klein"],motorrad:["motorraeder","bike"],chopper:["motorraeder","chopper"],roller:["roller-mopeds","roller"],moped:["roller-mopeds","moped"],quad:["quads-atvs","quad"],atv:["quads-atvs","atv"],lkw:["lkw","truck"],truck:["lkw","truck"],reifen:["reifen-felgen","reifen"],felgen:["reifen-felgen","felgen"],motorboot:["motorboote","motor"],segelboot:["segelboote","segel"],schlauchboot:["schlauchboote","schlauch"],citybike:["citybikes","city"],mountainbike:["mountainbikes","mtb"],rennrad:["rennraeder","renn"],ebike:["e-bikes","elektro"],kinderfahrrad:["kinderfahrraeder","kinder"],notebook:["notebooks","laptop"],laptop:["notebooks","laptop"],ultrabook:["notebooks","ultra"],desktop:["desktop-pcs","pc"],"gaming-pc":["desktop-pcs","gaming"],workstation:["desktop-pcs","work"],monitor:["monitore","display"],bildschirm:["monitore","screen"],"gaming-monitor":["monitore","gaming"],grafikkarte:["pc-komponenten","grafik"],prozessor:["pc-komponenten","cpu"],mainboard:["pc-komponenten","main"],ram:["pc-komponenten","ram"],ssd:["pc-komponenten","ssd"],drucker:["drucker-scanner","druck"],scanner:["drucker-scanner","scan"],iphone:["smartphones","iphone"],samsung:["smartphones","samsung"],android:["smartphones","android"],ipad:["tablets","ipad"],"android-tablet":["tablets","android"],"smart-tv":["fernseher","smart"],oled:["fernseher","oled"],qled:["fernseher","qled"],soundbar:["heimkino-soundsysteme","sound"],heimkino:["heimkino-soundsysteme","heimkino"],receiver:["heimkino-soundsysteme","receiver"],"bluetooth-kopfhörer":["kopfhoerer","bluetooth"],"in-ear":["kopfhoerer","in-ear"],"over-ear":["kopfhoerer","over-ear"],"bluetooth-lautsprecher":["lautsprecher","bluetooth"],boxen:["lautsprecher","box"],spiegelreflex:["digitalkameras","dslr"],systemkamera:["digitalkameras","system"],objektiv:["objektive","objektiv"],tele:["objektive","tele"],weitwinkel:["objektive","weit"],drohne:["drohnen","quadcopter"],quadcopter:["drohnen","quadcopter"],gopro:["action-cams","action"],"action-cam":["action-cams","action"],playstation:["spielekonsolen","ps"],ps4:["spielekonsolen","ps4"],ps5:["spielekonsolen","ps5"],xbox:["spielekonsolen","xbox"],nintendo:["spielekonsolen","switch"],switch:["spielekonsolen","switch"],videospiele:["videospiele","game"],"ps5-spiele":["videospiele","ps5"],alexa:["smart-home-systeme","alexa"],"google-home":["smart-home-systeme","google"],"smart-home":["smart-home-systeme","smart"],überwachungskamera:["sicherheit-ueberwachung","kamera"],alarmanlage:["sicherheit-ueberwachung","alarm"],"fitness-tracker":["wearables","fitness"],staubsauger:["staubsauger","saug"],saugroboter:["staubsauger","roboter"],damenschuhe:["damenschuhe","damen"],pumps:["damenschuhe","pumps"],herrenschuhe:["herrenschuhe","herren"],"business-schuhe":["herrenschuhe","business"],sneaker:["sportschuhe","sneaker"],laufschuhe:["sportschuhe","lauf"],kinderschuhe:["kinderschuhe","kinder"],armbanduhr:["armbanduhren","uhr"],smartwatch:["armbanduhren","smart"],ring:["ringe","ring"],verlobungsring:["ringe","verlobung"],kette:["ketten","hals"],halskette:["ketten","hals"],armband:["armbaender","arm"],ohrringe:["ohrringe","ohr"],handtasche:["handtaschen","hand"],clutch:["handtaschen","clutch"],wanderrucksack:["rucksaecke","wander"],koffer:["koffer-reisegepaeck","koffer"],trolley:["koffer-reisegepaeck","trolley"],gürtel:["guertel","gürtel"],ledergürtel:["guertel","leder"],sonnenbrille:["sonnenbrillen","sonnen"],hautpflege:["hautpflege","haut"],creme:["hautpflege","creme"],"make-up":["make-up","makeup"],lippenstift:["make-up","lippe"],parfum:["parfum","duft"],"eau-de-toilette":["parfum","eau"],babybett:["babybetten-wiegen","bett"],wiege:["babybetten-wiegen","wiege"],wickelkommode:["wickelkommoden","wickel"],babyphone:["babyphones","phone"],stillkissen:["stillen-fuettern","still"],flasche:["stillen-fuettern","flasche"],babykleidung:["babykleidung","baby"],strampler:["babykleidung","strampler"],mädchenkleidung:["maedchenkleidung","mädchen"],jungenkleidung:["jungenkleidung","jungen"],kinderwagen:["kinderwagen-buggys","wagen"],buggy:["kinderwagen-buggys","buggy"],autositz:["autositze","sitz"],kindersitz:["autositze","kinder"],laufrad:["laufraeder","lauf"],kinderroller:["kinderroller","roller"],schulranzen:["schulranzen","ranzen"],federmäppchen:["schreibwaren","mäppchen"],bilderbuch:["bilderbuecher","bild"],vorlesebuch:["vorlesebuecher","vorlese"],welpe:["hunde-welpen","welpe"],hund:["hunde-welpen","hund"],leine:["hundezubehoer","leine"],halsband:["hundezubehoer","hals"],hundefutter:["hundefutter","futter"],trockenfutter:["hundefutter","trocken"],hundespielzeug:["hundespielzeug","spiel"],ball:["hundespielzeug","ball"],kätzchen:["katzen-kitten","kitten"],katze:["katzen-kitten","katze"],kratzbaum:["katzenzubehoer","kratz"],katzenklo:["katzenzubehoer","klo"],katzenfutter:["katzenfutter","futter"],nassfutter:["katzenfutter","nass"],pferd:["pferde-ponys","pferd"],pony:["pferde-ponys","pony"],sattel:["reitzubehoer","sattel"],trense:["reitzubehoer","trense"],reithelm:["reitbekleidung","helm"],reitstiefel:["reitbekleidung","stiefel"],kaninchen:["kaninchen-meerschweinchen","kaninchen"],meerschweinchen:["kaninchen-meerschweinchen","meer"],hamster:["hamster-maeuse","hamster"],maus:["hamster-maeuse","maus"],wellensittich:["voegel","wellen"],papagei:["voegel","papagei"],käfig:["kaefige-gehege","käfig"],voliere:["kaefige-gehege","voliere"],aquarium:["aquarien","aquarium"],zierfisch:["fische","zier"],terrarium:["terrarien","terra"],schlange:["reptilien","schlange"],zelt:["zelte","zelt"],campingzelt:["zelte","camping"],schlafsack:["schlafsaecke","schlaf"],isomatte:["wandern-trekking","iso"],rucksack:["wandern-trekking","ruck"],campingtisch:["campingmoebel","tisch"],campingstuhl:["campingmoebel","stuhl"],hantel:["fitnessgeraete","hantel"],kurzhantel:["fitnessgeraete","kurz"],laufband:["fitnessgeraete","lauf"],crosstrainer:["fitnessgeraete","cross"],yogamatte:["yoga-pilates","yoga"],"pilates-ball":["yoga-pilates","pilates"],"e-gitarre":["gitarren","gitarre"],akustikgitarre:["gitarren","akustik"],keyboard:["keyboards-pianos","keyboard"],"e-piano":["keyboards-pianos","piano"],schlagzeug:["schlagzeug","drum"],"e-drum":["schlagzeug","elektronik"],"dj-controller":["dj-equipment","controller"],plattenspieler:["dj-equipment","platten"],"rc-auto":["rc-modelle","auto"],"rc-helikopter":["rc-modelle","heli"],modellbahn:["modellbahn","bahn"],h0:["modellbahn","h0"],roman:["romane","roman"],krimi:["romane","krimi"],sachbuch:["sachbuecher","sach"],biografie:["sachbuecher","bio"],kochbuch:["kochbuecher","koch"],rezepte:["kochbuecher","rezept"],comic:["comics-manga","comic"],manga:["comics-manga","manga"],münzen:["muenzen","münze"],euromünzen:["muenzen","euro"],briefmarken:["briefmarken","marke"],sammelkarten:["sammelkarten","karte"],pokemon:["sammelkarten","pokemon"],bohrmaschine:["elektrowerkzeuge","bohr"],akkuschrauber:["elektrowerkzeuge","akku"],winkelschleifer:["elektrowerkzeuge","winkel"],schraubendreher:["handwerkzeuge","schraub"],zange:["handwerkzeuge","zange"],kompressor:["kompressoren","kompressor"],druckluftkompressor:["kompressoren","druck"],schreibtisch:["schreibtische-buero","schreib"],höhenverstellbar:["schreibtische-buero","höhen"],bürostuhl:["buerostuehle","stuhl"],chefsessel:["buerostuehle","chef"],europalette:["paletten","palette"],gitterbox:["paletten","gitter"],windows:["betriebssysteme","windows"],macos:["betriebssysteme","mac"],linux:["betriebssysteme","linux"],office:["office-software","office"],word:["office-software","word"],excel:["office-software","excel"],photoshop:["grafik-software","photo"],illustrator:["grafik-software","illustrator"],premiere:["video-audio-software","premiere"],"final-cut":["video-audio-software","final"],antivirus:["sicherheitssoftware","anti"],firewall:["sicherheitssoftware","fire"],"ios-app":["mobile-apps","ios"],"android-app":["mobile-apps","android"],domain:["domains","domain"],"de-domain":["domains","de"],wordpress:["webseiten-templates","wordpress"],shopify:["webseiten-templates","shop"],nft:["nft-kunst","nft"],"crypto-art":["nft-kunst","crypto"],"3d-modell":["3d-modelle","3d"],blender:["3d-modelle","blender"],stockfoto:["stockfotos","stock"],foto:["stockfotos","foto"],chatgpt:["chatgpt-prompts","gpt"],"gpt-4":["chatgpt-prompts","gpt-4"],midjourney:["midjourney-prompts","mid"],"stable-diffusion":["ai-modelle","stable"]},{data:S,error:je}=await D.from("categories").select("*");if(!je&&S){const C=S.find(h=>{var G,w,k,q,I,$;return h.level===1&&(((k=(w=(G=h.translations)==null?void 0:G.de)==null?void 0:w.name)==null?void 0:k.toLowerCase().includes(a.category.toLowerCase()))||(($=(I=(q=h.translations)==null?void 0:q.en)==null?void 0:I.name)==null?void 0:$.toLowerCase().includes(a.category.toLowerCase()))||h.slug.toLowerCase().includes(a.category.toLowerCase()))});if(console.log("✅ Found level 1 category:",((v=(d=C==null?void 0:C.translations)==null?void 0:d.de)==null?void 0:v.name)||(C==null?void 0:C.slug)),C){if(f.level1=C,a.subcategory){const h=a.subcategory.toLowerCase();let G=S.find(w=>{var k,q,I,$,J,oe;return w.level===2&&w.parent_id===C.id&&(((I=(q=(k=w.translations)==null?void 0:k.de)==null?void 0:q.name)==null?void 0:I.toLowerCase().includes(h))||((oe=(J=($=w.translations)==null?void 0:$.en)==null?void 0:J.name)==null?void 0:oe.toLowerCase().includes(h))||w.slug.toLowerCase().includes(h))});if(!G&&s[h]){console.log("🔄 Trying semantic mapping for subcategory:",h,"→",s[h]);const w=s[h];G=S.find(k=>k.level===2&&k.parent_id===C.id&&w.some(q=>{var I,$,J;return((J=($=(I=k.translations)==null?void 0:I.de)==null?void 0:$.name)==null?void 0:J.toLowerCase().includes(q))||k.slug.toLowerCase().includes(q)}))}if(G){if(f.level2=G,se=G.id,console.log("✅ Found level 2 category:",((U=(u=G.translations)==null?void 0:u.de)==null?void 0:U.name)||G.slug),E[h]){console.log("🔄 Trying semantic mapping for level 3:",h,"→",E[h]);const w=E[h],k=S.find(q=>q.level===3&&q.parent_id===G.id&&w.some(I=>{var $,J,oe;return((oe=(J=($=q.translations)==null?void 0:$.de)==null?void 0:J.name)==null?void 0:oe.toLowerCase().includes(I))||q.slug.toLowerCase().includes(I)}));k&&(f.level3=k,se=k.id,console.log("✅ Found level 3 category via semantic mapping:",((ce=(Y=k.translations)==null?void 0:Y.de)==null?void 0:ce.name)||k.slug))}}else console.log("⚠️ No level 2 match found for subcategory:",h)}if(!f.level2){const h=`${a.title} ${a.description}`.toLowerCase(),w=S.filter(k=>k.level===2&&k.parent_id===C.id).find(k=>{var $,J,oe;const q=((oe=(J=($=k.translations)==null?void 0:$.de)==null?void 0:J.name)==null?void 0:oe.toLowerCase())||"",I=k.slug.toLowerCase();return h.includes(q)||h.includes(I)||I.includes("auto")&&(h.includes("auto")||h.includes("vw")||h.includes("bmw")||h.includes("mercedes"))});w&&(f.level2=w,se=w.id,console.log("✅ Inferred level 2 from title/description:",((re=(ae=w.translations)==null?void 0:ae.de)==null?void 0:re.name)||w.slug))}if(f.level2){const h=`${a.title} ${a.description}`.toLowerCase(),w=S.filter(k=>k.level===3&&k.parent_id===f.level2.id).find(k=>{var $,J,oe;const q=((oe=(J=($=k.translations)==null?void 0:$.de)==null?void 0:J.name)==null?void 0:oe.toLowerCase())||"",I=k.slug.toLowerCase();return h.includes(q)||h.includes(I)||I.includes("geschirr")&&h.includes("geschirr")||I.includes("besteck")&&h.includes("besteck")||I.includes("teller")&&h.includes("teller")||I.includes("tassen")&&h.includes("tasse")||I.includes("glaeser")&&h.includes("glas")});w&&(f.level3=w,se=w.id,console.log("✅ Inferred level 3 from title/description:",((Ee=(R=w.translations)==null?void 0:R.de)==null?void 0:Ee.name)||w.slug))}se||(se=((ne=f.level2)==null?void 0:ne.id)||C.id,console.log("⚠️ Using Level",f.level2?"2":"1","category (no deeper level found)"))}else console.warn("❌ No matching category found for:",a.category)}}if(a.category_id=se,console.log("📂 Category mapping complete:",{level1:(qe=(tt=(z=f.level1)==null?void 0:z.translations)==null?void 0:tt.de)==null?void 0:qe.name,level2:(me=(t=($e=f.level2)==null?void 0:$e.translations)==null?void 0:t.de)==null?void 0:me.name,level3:(N=(pe=(ge=f.level3)==null?void 0:ge.translations)==null?void 0:pe.de)==null?void 0:N.name,finalCategoryId:se}),se)try{const{data:s}=await D.from("categories").select("*").eq("id",se).single();if(s){if(s.level===3){f.level3=s;const{data:E}=await D.from("categories").select("*").eq("id",s.parent_id).single();if(E){f.level2=E;const{data:S}=await D.from("categories").select("*").eq("id",E.parent_id).single();S&&(f.level1=S)}}else if(s.level===2){f.level2=s;const{data:E}=await D.from("categories").select("*").eq("id",s.parent_id).single();E&&(f.level1=E)}else s.level===1&&(f.level1=s);jt(f),console.log("📂 Category loaded into UI:",f)}}catch(s){console.error("Failed to load category for UI:",s)}r?(St({analyses:Me,scoredAnalyses:Re,mergedAnalysis:a,categoryInfo:{level1:((m=(Fe=(De=f.level1)==null?void 0:De.translations)==null?void 0:Fe.de)==null?void 0:m.name)||((ze=f.level1)==null?void 0:ze.slug),level2:((p=(g=(c=f.level2)==null?void 0:c.translations)==null?void 0:g.de)==null?void 0:p.name)||((_=f.level2)==null?void 0:_.slug),level3:((le=(b=(T=f.level3)==null?void 0:T.translations)==null?void 0:b.de)==null?void 0:le.name)||((L=f.level3)==null?void 0:L.slug)}}),Ue(!0),console.log("🎨 [Developer Mode] Preview shown with category:",{level1:(Z=(B=(ee=f.level1)==null?void 0:ee.translations)==null?void 0:B.de)==null?void 0:Z.name,level2:(qt=(fe=(X=f.level2)==null?void 0:X.translations)==null?void 0:fe.de)==null?void 0:qt.name,level3:(Gt=(Rt=($t=f.level3)==null?void 0:$t.translations)==null?void 0:Rt.de)==null?void 0:Gt.name})):(console.log("🚀 [Production Mode] Skipping preview, publishing directly..."),await et(a))}catch(xe){console.error("Error in handleAIGenerate:",xe),ke(xe instanceof Error?xe.message:"Analyse fehlgeschlagen")}finally{gt(!1)}}},et=async d=>{var ce,ae,re,R,Ee;if(!j)return;const v=(d==null?void 0:d.title)||Qe,u=(d==null?void 0:d.description)||Ye,U=(d==null?void 0:d.price)||parseFloat(Te);if(!v||!u||!U)return;if(!j.email_confirmed_at){ke("Bitte bestätigen Sie zuerst Ihre E-Mail-Adresse.");return}console.log("[Credit Check] Checking credits before listing creation...");const Y=await de();if(console.log("[Credit Check] Result:",Y),!Y.canCreate){ke(Y.message||"Du kannst derzeit kein Inserat erstellen. Bitte spende oder kaufe Credits.");return}pt(!0),ke("");try{const ne=[];for(const c of l){const g=c.file.name.split(".").pop(),p=`${j.id}/${Date.now()}-${c.id}.${g}`,{error:_}=await D.storage.from("item-images").upload(p,c.file);if(_)throw _;const{data:{publicUrl:T}}=D.storage.from("item-images").getPublicUrl(p);ne.push(T)}const z=Ke.find(c=>c.id===Le),qe={Deutschland:"DE",Österreich:"AT",Schweiz:"CH",Frankreich:"FR",Italien:"IT",Spanien:"ES",Niederlande:"NL",Belgien:"BE",Polen:"PL",Tschechien:"CZ"}[(z==null?void 0:z.country)||ei()]||"DE",$e=ne[l.findIndex(c=>c.isPrimary)]||ne[0],t=d||We,me=((ce=t==null?void 0:t.tokenUsage)==null?void 0:ce.inputTokens)||0,ge=((ae=t==null?void 0:t.tokenUsage)==null?void 0:ae.outputTokens)||0,pe=me+ge;console.log("[Item Insert] Gemini Tokens:",{input:me,output:ge,total:pe,hasTokenUsage:!!(t!=null&&t.tokenUsage)});let N=(t==null?void 0:t.category_id)||or(zt);if(!N&&(t!=null&&t.category)){console.log("Mapping AI text categories to hierarchical system:",{category:t.category,subcategory:t.subcategory});const{data:c,error:g}=await D.from("categories").select("*");if(g)throw g;const p=c==null?void 0:c.find(b=>{var le,L,ee,B,Z,X;return b.level===1&&(((ee=(L=(le=b.translations)==null?void 0:le.de)==null?void 0:L.name)==null?void 0:ee.toLowerCase().includes(t.category.toLowerCase()))||((X=(Z=(B=b.translations)==null?void 0:B.en)==null?void 0:Z.name)==null?void 0:X.toLowerCase().includes(t.category.toLowerCase()))||b.slug.toLowerCase().includes(t.category.toLowerCase()))});console.log("Found level 1 category:",p);let _=null;if(p&&t.subcategory&&(_=c==null?void 0:c.find(b=>{var le,L,ee,B,Z,X;return b.level===2&&b.parent_id===p.id&&(((ee=(L=(le=b.translations)==null?void 0:le.de)==null?void 0:L.name)==null?void 0:ee.toLowerCase().includes(t.subcategory.toLowerCase()))||((X=(Z=(B=b.translations)==null?void 0:B.en)==null?void 0:Z.name)==null?void 0:X.toLowerCase().includes(t.subcategory.toLowerCase()))||b.slug.toLowerCase().includes(t.subcategory.toLowerCase()))}),console.log("Found level 2 category from subcategory:",_)),p&&!_){const b=`${v} ${u}`.toLowerCase();_=((c==null?void 0:c.filter(L=>L.level===2&&L.parent_id===p.id))||[]).find(L=>{var Z,X,fe;const ee=((fe=(X=(Z=L.translations)==null?void 0:Z.de)==null?void 0:X.name)==null?void 0:fe.toLowerCase())||"",B=L.slug.toLowerCase();return b.includes(ee)||b.includes(B)||B.includes("auto")&&(b.includes("auto")||b.includes("vw")||b.includes("bmw")||b.includes("mercedes"))}),_&&console.log("Inferred level 2 category from title/description:",_)}let T=null;if(_){const b=`${v} ${u}`.toLowerCase();T=((c==null?void 0:c.filter(L=>L.level===3&&L.parent_id===_.id))||[]).find(L=>{var Z,X,fe;const ee=((fe=(X=(Z=L.translations)==null?void 0:Z.de)==null?void 0:X.name)==null?void 0:fe.toLowerCase())||"",B=L.slug.toLowerCase();return b.includes(ee)||b.includes(B)||B.includes("geschirr")&&b.includes("geschirr")||B.includes("besteck")&&b.includes("besteck")||B.includes("teller")&&b.includes("teller")||B.includes("tassen")&&b.includes("tasse")||B.includes("glaeser")&&b.includes("glas")}),T&&console.log("✅ Inferred level 3 category from title/description:",T)}T?(N=T.id,console.log("✅ Using Level 3 category:",N)):_?(N=_.id,console.log("✅ Using Level 2 category:",N)):p&&(N=p.id,console.log("⚠️ Using Level 1 category (no Level 2/3 found):",N))}if(!N)throw new Error("Bitte wähle eine Kategorie aus, bevor du das Inserat erstellst.");const{data:De,error:Fe}=await D.from("categories").select("id").eq("id",N).maybeSingle();if(Fe||!De)throw console.error("Category validation failed:",{categoryId:N,categoryError:Fe,categoryExists:De}),new Error("Die ausgewählte Kategorie ist ungültig. Bitte wähle eine andere Kategorie.");(t!=null&&t.vehicle_brand||t!=null&&t.vehicle_year||t!=null&&t.vehicle_mileage)&&console.log("[Vehicle Attributes] Preparing to insert:",{vehicle_brand:t==null?void 0:t.vehicle_brand,vehicle_year:t==null?void 0:t.vehicle_year,vehicle_mileage:t==null?void 0:t.vehicle_mileage,vehicle_fuel_type:t==null?void 0:t.vehicle_fuel_type,vehicle_color:t==null?void 0:t.vehicle_color,vehicle_power_kw:t==null?void 0:t.vehicle_power_kw,vehicle_first_registration:t==null?void 0:t.vehicle_first_registration,vehicle_tuv_until:t==null?void 0:t.vehicle_tuv_until});const{data:m,error:ze}=await D.from("items").insert({user_id:j.id,title:v,description:u,price:U,image_url:$e,status:Q?"published":"draft",ai_generated:t!==null,category_id:(t==null?void 0:t.category_id)||N,condition:t==null?void 0:t.condition,brand:t==null?void 0:t.brand,size:t==null?void 0:t.size,weight:t==null?void 0:t.weight,dimensions_length:(re=t==null?void 0:t.dimensions)==null?void 0:re.length,dimensions_width:(R=t==null?void 0:t.dimensions)==null?void 0:R.width,dimensions_height:(Ee=t==null?void 0:t.dimensions)==null?void 0:Ee.height,material:t==null?void 0:t.material,colors:t==null?void 0:t.colors,style:t==null?void 0:t.style,serial_number:t==null?void 0:t.serialNumber,features:t==null?void 0:t.features,accessories:t==null?void 0:t.accessories,tags:t==null?void 0:t.tags,postal_code:z==null?void 0:z.postal_code,location:z==null?void 0:z.city,estimated_weight_kg:t==null?void 0:t.estimated_weight_kg,package_dimensions:t==null?void 0:t.package_dimensions,ai_shipping_domestic:t==null?void 0:t.ai_shipping_domestic,ai_shipping_international:t==null?void 0:t.ai_shipping_international,selected_address_id:Le||null,shipping_from_country:qe,snapshot_shipping_enabled:It,snapshot_shipping_cost:Dt,snapshot_shipping_cost_type:Lt,snapshot_shipping_description:Mt||null,snapshot_pickup_enabled:Bt,snapshot_show_location_publicly:qi,price_negotiable:W,is_free:Ze,price_on_request:ut,duration_days:Xe,snapshot_pickup_address:z==null?void 0:z.address,snapshot_pickup_postal_code:z==null?void 0:z.postal_code,snapshot_pickup_city:z==null?void 0:z.city,snapshot_pickup_country:z==null?void 0:z.country,snapshot_location_description:(we==null?void 0:we.location_description)||null,vehicle_brand:t==null?void 0:t.vehicle_brand,vehicle_year:t==null?void 0:t.vehicle_year,vehicle_mileage:t==null?void 0:t.vehicle_mileage,vehicle_fuel_type:t==null?void 0:t.vehicle_fuel_type,vehicle_color:t==null?void 0:t.vehicle_color,vehicle_power_kw:t==null?void 0:t.vehicle_power_kw,vehicle_first_registration:t==null?void 0:t.vehicle_first_registration,vehicle_tuv_until:t==null?void 0:t.vehicle_tuv_until,gemini_input_tokens:me,gemini_output_tokens:ge,gemini_tokens_used:pe}).select().single();if(ze)throw console.error("Item insert error:",ze),console.error("Insert data:",{category_id:(t==null?void 0:t.category_id)||N,title:v,price:U,status:Q?"published":"draft"}),new Error(`Fehler beim Erstellen des Inserats: ${ze.message}`);if(console.log("Item created:",m),m&&(m.vehicle_brand||m.vehicle_year||m.vehicle_mileage)?console.log("[Vehicle Attributes] Successfully inserted:",{vehicle_brand:m.vehicle_brand,vehicle_year:m.vehicle_year,vehicle_mileage:m.vehicle_mileage,vehicle_fuel_type:m.vehicle_fuel_type,vehicle_color:m.vehicle_color,vehicle_power_kw:m.vehicle_power_kw,vehicle_first_registration:m.vehicle_first_registration,vehicle_tuv_until:m.vehicle_tuv_until}):m&&console.log("[Vehicle Attributes] No vehicle attributes in returned item data"),ne.length>0&&m){const c=ne.map((p,_)=>{var T;return{item_id:m.id,image_url:p,display_order:_,is_primary:((T=l[_])==null?void 0:T.isPrimary)||_===0}});console.log("Inserting item images:",c.length);const{error:g}=await D.from("item_images").insert(c);if(g)throw g;console.log("Images inserted successfully")}if(m&&t&&N==="f5fb69d5-e054-47e8-a72e-dc05fc3620bf"){console.log("[Vehicle Attributes] Saving vehicle attributes...");const{data:c}=await D.from("category_attributes").select("id, attribute_key").eq("category_id",N);if(c&&c.length>0){const g=new Map(c.map(_=>[_.attribute_key,_.id])),p=[];if(t.vehicle_brand&&g.has("brand")&&p.push({item_id:m.id,attribute_id:g.get("brand"),value_text:t.vehicle_brand}),t.vehicle_year&&g.has("year")&&p.push({item_id:m.id,attribute_id:g.get("year"),value_number:t.vehicle_year}),t.vehicle_mileage&&g.has("mileage")&&p.push({item_id:m.id,attribute_id:g.get("mileage"),value_number:t.vehicle_mileage}),t.vehicle_fuel_type&&g.has("fuel_type")&&p.push({item_id:m.id,attribute_id:g.get("fuel_type"),value_text:t.vehicle_fuel_type}),t.vehicle_color&&g.has("color")&&p.push({item_id:m.id,attribute_id:g.get("color"),value_text:t.vehicle_color}),t.vehicle_power_kw&&g.has("power_kw")&&p.push({item_id:m.id,attribute_id:g.get("power_kw"),value_number:t.vehicle_power_kw}),t.vehicle_first_registration&&g.has("first_registration")&&p.push({item_id:m.id,attribute_id:g.get("first_registration"),value_date:t.vehicle_first_registration}),t.vehicle_tuv_until&&g.has("tuv_until")&&p.push({item_id:m.id,attribute_id:g.get("tuv_until"),value_date:t.vehicle_tuv_until}),p.length>0){const{error:_}=await D.from("item_attributes").insert(p);_?console.error("[Vehicle Attributes] Error saving attributes:",_):console.log("[Vehicle Attributes] Saved",p.length,"attributes")}}}if(m&&Ne){console.log("[Meta-Categories] Saving meta-categories...",Ne);const c=[];if(Object.values(Ne).forEach(g=>{Array.isArray(g)&&g.forEach(p=>{p&&c.push({item_id:m.id,meta_category_id:p})})}),c.length>0){const{error:g}=await D.from("item_meta_categories").insert(c);g?console.error("[Meta-Categories] Error saving meta-categories:",g):console.log("[Meta-Categories] Saved",c.length,"meta-categories")}}if(console.log("[Credit Check] Processing credit deduction...",{creditSource:Y.source,geminiTokens:pe,aiGenerated:t!==null}),pe>0){console.log("[Credit Check] AI listing detected - deducting credits based on Gemini tokens...");const c=await P(j.id,m.id,me,ge,`AI listing creation: ${v}`);if(!c.success){console.error("[Credit Check] Failed to deduct credits:",c.error),ke(c.error||"Fehler beim Abziehen der Credits");return}console.log("[Credit Check] Credits deducted successfully:",{creditsUsed:c.creditsUsed,newBalance:c.newBalance,geminiInputTokens:me,geminiOutputTokens:ge,totalTokens:pe})}else Y.source==="community_pot"?(console.log("[Credit Check] Manual listing using community pot (free listing)"),await he(Y.source,m.id)||console.error("[Credit Check] Failed to consume community pot credit")):console.log("[Credit Check] Manual listing with personal credits - FREE (0 credits)");console.log("Navigating to:",`/item/${m.id}`),M(`/item/${m.id}`)}catch(ne){ke(ne instanceof Error?ne.message:"Upload fehlgeschlagen")}finally{pt(!1)}};return e.jsxs(Ui,{maxWidth:"md",sx:{py:4,pb:12},children:[Ct&&ye&&e.jsx(pr,{analyses:ye.analyses,scoredAnalyses:ye.scoredAnalyses,mergedAnalysis:ye.mergedAnalysis,categoryInfo:ye.categoryInfo,onConfirm:async()=>{Ue(!1),await et(ye.mergedAnalysis)},onCancel:()=>{Ue(!1),St(null)}}),!Ct&&e.jsxs(e.Fragment,{children:[e.jsxs(n,{sx:{mb:4,textAlign:"center"},children:[e.jsx(i,{variant:"h4",sx:{fontWeight:700,color:"primary.main",fontSize:{xs:"1.75rem",md:"2.125rem"},letterSpacing:"-0.02em",mb:.75},children:"Artikel erstellen"}),e.jsx(i,{variant:"body2",sx:{color:"text.secondary",fontSize:"0.9rem",maxWidth:"500px",mx:"auto"},children:"Lade deine Bilder hoch und lass die KI die Arbeit machen"})]}),e.jsx(Ve,{elevation:0,sx:{mb:3,p:2,borderRadius:2,border:"1px solid",borderColor:x>0?"success.light":"info.light",bgcolor:x>0?"rgba(46, 125, 50, 0.04)":"rgba(25, 118, 210, 0.04)"},children:e.jsxs(n,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:.5},children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Pe,{size:20,style:{color:x>0?"#2e7d32":"#1976d2"}}),e.jsx(i,{variant:"body1",sx:{fontWeight:600,color:x>0?"success.main":"info.main"},children:x>0?`${x} ${x===1?"KI-Inserat":"KI-Inserate"} verfügbar`:"Keine KI-Inserate verfügbar"})]}),e.jsx(i,{variant:"caption",sx:{color:"text.secondary",fontSize:"0.75rem"},children:"Manuelle Inserate sind immer kostenlos möglich"})]})}),ft&&e.jsx(Yt,{severity:"error",sx:{mb:3},children:ft}),xt&&di&&e.jsx(Ae,{in:xt,children:e.jsx(Yt,{severity:"info",icon:e.jsx(Pe,{size:20}),action:e.jsx(Oe,{size:"small",onClick:()=>vt(!1),sx:{color:"inherit"},children:e.jsx(Tt,{size:18})}),sx:{mb:3,backgroundColor:"rgba(16, 185, 129, 0.08)",borderColor:"#10b981",border:"1px solid","& .MuiAlert-icon":{color:"#10b981"}},children:e.jsxs(n,{children:[e.jsx(i,{variant:"subtitle2",sx:{fontWeight:600,mb:.5,color:"#047857"},children:"💡 Willkommen! Ihr erster Artikel"}),e.jsx(i,{variant:"body2",sx:{color:"text.secondary",mb:1},children:"Laden Sie einfach Fotos hoch - unser KI-Assistent analysiert die Bilder automatisch und schlägt Titel, Beschreibung, Preis und weitere Details vor."}),e.jsxs(i,{variant:"caption",sx:{color:"text.secondary",display:"block"},children:["Sie können die KI-Einstellungen jederzeit unter ",e.jsx("strong",{children:"Profil → Einstellungen → KI-Assistent"})," anpassen."]})]})})}),l.length===0?e.jsx(ii,{images:l,onImagesChange:y}):e.jsxs(Ve,{sx:{p:{xs:1.75,md:2.25},borderRadius:2.5,mb:2.5},children:[e.jsx(ii,{images:l,onImagesChange:y}),l.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs(n,{sx:{mt:2.5,p:2,border:"1.5px solid",borderColor:"primary.main",borderRadius:1.5,bgcolor:"rgba(25, 118, 210, 0.02)"},children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:1.25,flexWrap:"wrap",gap:1},children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:.75},children:[e.jsx(Pe,{size:16,style:{color:"#1976d2"}}),e.jsx(i,{variant:"subtitle2",sx:{fontWeight:600,color:"primary.main",fontSize:"0.875rem"},children:"KI-Unterstützung"})]}),We&&bt>0&&e.jsx(F,{icon:e.jsx(er,{size:12}),label:`≈${bt} Credits`,size:"small",variant:"outlined",color:"warning",sx:{fontWeight:600,height:"24px",fontSize:"0.75rem"}})]}),e.jsx(ot,{fullWidth:!0,multiline:!0,rows:2,label:"Zusätzliche Informationen für die KI (optional)",placeholder:"z.B. Erbstück, Notverkauf, versteckte Mängel, besondere Merkmale...",value:ue,onChange:d=>He(d.target.value),helperText:"Hilft der KI für bessere Beschreibung und realistischeren Preis",sx:{"& .MuiOutlinedInput-root":{backgroundColor:"white"},"& .MuiInputBase-input":{fontSize:"0.875rem"},"& .MuiFormHelperText-root":{fontSize:"0.7rem"}}}),e.jsx(Ae,{in:ui,children:e.jsxs(n,{sx:{mt:1.5,p:1.5,bgcolor:"rgba(255, 152, 0, 0.04)",borderRadius:1,border:"1px solid",borderColor:"rgba(255, 152, 0, 0.3)"},children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:1},children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:.75},children:[e.jsx(ar,{size:16,style:{color:"#ed6c02"}}),e.jsx(i,{variant:"subtitle2",sx:{fontWeight:600,color:"warning.main",fontSize:"0.8rem"},children:"Tipp: So verbessern Sie das KI-Ergebnis deutlich"})]}),e.jsx(Oe,{size:"small",onClick:()=>mi(!1),sx:{p:.25},children:e.jsx(Tt,{size:14})})]}),e.jsx(i,{variant:"caption",sx:{display:"block",mb:1.25,color:"text.secondary",fontSize:"0.75rem",lineHeight:1.4},children:"Die KI kann nur sehen, was auf den Bildern zu erkennen ist. Geben Sie zusätzliche Infos an, die schwer zu erkennen sind:"}),e.jsxs(n,{sx:{display:"flex",flexDirection:"column",gap:1},children:[e.jsxs(n,{sx:{display:"flex",gap:1,alignItems:"flex-start"},children:[e.jsx(tr,{size:14,style:{marginTop:"2px",flexShrink:0,color:"#666"}}),e.jsxs(n,{children:[e.jsx(i,{variant:"caption",sx:{fontWeight:600,fontSize:"0.7rem",color:"text.primary"},children:"Elektronik:"}),e.jsx(i,{variant:"caption",sx:{fontSize:"0.7rem",color:"text.secondary",display:"block"},children:'"iPhone 17 Pro, 256GB, Space Gray, OVP vorhanden"'})]})]}),e.jsxs(n,{sx:{display:"flex",gap:1,alignItems:"flex-start"},children:[e.jsx(ir,{size:14,style:{marginTop:"2px",flexShrink:0,color:"#666"}}),e.jsxs(n,{children:[e.jsx(i,{variant:"caption",sx:{fontWeight:600,fontSize:"0.7rem",color:"text.primary"},children:"Fahrzeuge:"}),e.jsx(i,{variant:"caption",sx:{fontSize:"0.7rem",color:"text.secondary",display:"block"},children:'"VW Golf 8, Baujahr 2021, 45.000 km, TÜV bis 08/2025"'})]})]}),e.jsxs(n,{sx:{display:"flex",gap:1,alignItems:"flex-start"},children:[e.jsx(rr,{size:14,style:{marginTop:"2px",flexShrink:0,color:"#666"}}),e.jsxs(n,{children:[e.jsx(i,{variant:"caption",sx:{fontWeight:600,fontSize:"0.7rem",color:"text.primary"},children:"Zusätzliche Fotos:"}),e.jsx(i,{variant:"caption",sx:{fontSize:"0.7rem",color:"text.secondary",display:"block"},children:"Laden Sie Zulassungsschein, Rechnung, Planette oder technische Daten hoch"})]})]}),e.jsxs(n,{sx:{display:"flex",gap:1,alignItems:"flex-start"},children:[e.jsx(nr,{size:14,style:{marginTop:"2px",flexShrink:0,color:"#666"}}),e.jsxs(n,{children:[e.jsx(i,{variant:"caption",sx:{fontWeight:600,fontSize:"0.7rem",color:"text.primary"},children:"Wichtige Details:"}),e.jsx(i,{variant:"caption",sx:{fontSize:"0.7rem",color:"text.secondary",display:"block"},children:"Modellbezeichnung, Seriennummer, Garantie, versteckte Mängel"})]})]})]})]})})]}),e.jsx(gr,{pickupAddress:(()=>{const d=Ke.find(u=>u.id===Le);return d?[d.address,d.postal_code,d.city].filter(Boolean).join(", "):""})(),shippingEnabled:It,shippingCostType:Lt,shippingCostFixed:Dt,shippingDescription:Mt,priceNegotiable:W,isFree:Ze,duration:Xe,onShippingEnabledChange:Wt,onShippingCostTypeChange:Et,onShippingCostFixedChange:Ft,onShippingDescriptionChange:Pt,onPriceNegotiableChange:dt,onIsFreeChange:ht,onDurationChange:mt,pickupEnabled:Bt,onPickupEnabledChange:Kt,phoneVisible:(()=>{const d=Ke.find(v=>v.id===Le);return(d==null?void 0:d.show_phone_publicly)||!1})()})]}),K==="choose"&&l.length>0&&e.jsxs(n,{sx:{mt:2.5},children:[e.jsxs(n,{sx:{display:"flex",gap:1.5,flexDirection:{xs:"column",sm:"row"}},children:[e.jsx(Ie,{fullWidth:!0,variant:"outlined",onClick:()=>H("manual"),sx:{py:1.25,textTransform:"none",fontSize:"0.9rem",fontWeight:500,borderRadius:1.5},children:"Manuell weitermachen"}),e.jsx(Ie,{fullWidth:!0,variant:"contained",onClick:Nt,disabled:_e||x<1,startIcon:_e?e.jsx(nt,{size:16,color:"inherit"}):e.jsx(Pe,{size:16}),sx:{py:1.25,textTransform:"none",fontSize:"0.9rem",fontWeight:600,borderRadius:1.5,boxShadow:2},children:_e?"Generiere mit KI...":"Mit KI erzeugen"})]}),e.jsx(n,{sx:{mt:1.5,p:1.15,bgcolor:"rgba(25, 118, 210, 0.04)",borderRadius:1,border:"1px solid",borderColor:"rgba(25, 118, 210, 0.2)"},children:e.jsx(Se,{control:e.jsx(Ut,{checked:Q,onChange:d=>ve(d.target.checked),size:"small"}),label:e.jsxs(n,{children:[e.jsx(i,{variant:"body2",sx:{fontWeight:500,fontSize:"0.85rem"},children:"Gleich veröffentlichen"}),e.jsx(i,{variant:"caption",color:"text.secondary",sx:{fontSize:"0.75rem"},children:"Nach KI-Generierung direkt veröffentlichen"})]}),sx:{m:0}})})]})]}),K==="manual"&&e.jsxs(Ve,{sx:{borderRadius:3,overflow:"hidden"},children:[e.jsxs(n,{sx:{p:3},children:[e.jsx(i,{variant:"h6",fontWeight:600,gutterBottom:!0,sx:{mb:3},children:"Artikelinformationen"}),e.jsxs(n,{sx:{display:"flex",flexDirection:"column",gap:3},children:[e.jsxs(at,{defaultExpanded:!0,elevation:0,sx:{border:"1px solid",borderColor:"divider","&:before":{display:"none"}},children:[e.jsx(lt,{expandIcon:e.jsx(Be,{size:20}),sx:{bgcolor:"rgba(25, 118, 210, 0.04)","&:hover":{bgcolor:"rgba(25, 118, 210, 0.08)"}},children:e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(sr,{size:20,color:"#1976d2"}),e.jsx(i,{fontWeight:600,children:"Grundinformationen"})]})}),e.jsx(ct,{sx:{p:3},children:e.jsx(lr,{title:Qe,description:Ye,price:Te,category:zt,brand:gi,condition:fi,tags:ki,priceNegotiable:W,isFree:Ze,priceOnRequest:ut,duration:Xe,onTitleChange:_t,onDescriptionChange:wt,onPriceChange:yt,onCategoryChange:jt,onBrandChange:pi,onConditionChange:bi,onTagsChange:xi,onPriceNegotiableChange:dt,onIsFreeChange:ht,onPriceOnRequestChange:si,onDurationChange:mt,metaCategories:Ne,onMetaCategoriesChange:(d,v)=>{vi(u=>({...u,[d]:v}))},isMobile:A,hideExtendedSettings:!0})})]}),e.jsxs(at,{elevation:0,sx:{border:"1px solid",borderColor:"divider","&:before":{display:"none"}},children:[e.jsx(lt,{expandIcon:e.jsx(Be,{size:20}),sx:{bgcolor:"rgba(156, 39, 176, 0.04)","&:hover":{bgcolor:"rgba(156, 39, 176, 0.08)"}},children:e.jsxs(n,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(st,{size:20,color:"#9c27b0"}),e.jsx(i,{fontWeight:600,children:"Details (Optional)"})]})}),e.jsx(ct,{sx:{p:3},children:e.jsx(cr,{size:_i,weight:yi,dimensionsLength:ji,dimensionsWidth:Si,dimensionsHeight:Wi,material:Ei,colors:Fi,style:Pi,serialNumber:Ki,onSizeChange:wi,onWeightChange:zi,onDimensionsChange:(d,v,u)=>{Ci(d),Ii(v),Li(u)},onMaterialChange:Di,onColorsChange:Mi,onStyleChange:Bi,onSerialNumberChange:Ni,isMobile:A})})]})]})]}),e.jsxs(n,{sx:{p:3,pt:0},children:[e.jsx(n,{sx:{mb:2,p:1.5,bgcolor:"rgba(25, 118, 210, 0.04)",borderRadius:1,border:"1px solid",borderColor:"rgba(25, 118, 210, 0.2)"},children:e.jsx(Se,{control:e.jsx(Ut,{checked:Q,onChange:d=>ve(d.target.checked),size:"small"}),label:e.jsxs(n,{children:[e.jsx(i,{variant:"body2",sx:{fontWeight:500},children:"Gleich veröffentlichen"}),e.jsx(i,{variant:"caption",color:"text.secondary",children:"Inserat direkt online stellen (sonst als Entwurf speichern)"})]}),sx:{m:0}})}),e.jsxs(n,{sx:{display:"flex",gap:2,flexDirection:{xs:"column",sm:"row"}},children:[e.jsx(Ie,{fullWidth:!0,variant:"outlined",size:"large",onClick:Nt,disabled:_e,startIcon:_e?e.jsx(nt,{size:18,color:"inherit"}):e.jsx(Pe,{size:18}),sx:{py:1.5,textTransform:"none",fontSize:"0.95rem",fontWeight:500,borderRadius:2},children:_e?"Generiere mit KI...":"Mit KI erzeugen"}),e.jsx(Ie,{fullWidth:!0,variant:"contained",size:"large",onClick:()=>et(),disabled:Je||!Qe||!Ye||!Te,startIcon:Je?e.jsx(nt,{size:18,color:"inherit"}):e.jsx(ur,{size:18}),sx:{py:1.5,textTransform:"none",fontSize:"0.95rem",fontWeight:600,borderRadius:2},children:Je?"Speichere...":Q?"Veröffentlichen":"Als Entwurf speichern"})]})]})]})]})]})};export{Er as ItemCreatePage};
