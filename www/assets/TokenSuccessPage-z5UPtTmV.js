import{H as z,r as o,G as v,R as W,aR as _,j as e,B as f,a2 as P,J as R,$ as I,T as i,y as j,av as S,aH as A}from"./index-Cr_aSuNE.js";import{A as B}from"./alert-circle-BUd0o05b.js";import{A as F}from"./arrow-right-BXqj8CH4.js";const Z=()=>{const{user:r}=z(),[x,l]=o.useState(0),[d,g]=o.useState(0),[m,b]=o.useState(0),[w,u]=o.useState(!0),[k,h]=o.useState(null),p=async()=>{if(!r){l(0),g(0),b(0),u(!1);return}try{u(!0);const{data:s,error:t}=await v.from("profiles").select("personal_credits").eq("id",r.id).single();if(t)throw t;l((s==null?void 0:s.personal_credits)??0);const{data:n,error:c}=await v.from("credit_transactions").select("amount, transaction_type").eq("user_id",r.id);if(c)throw c;const y=(n==null?void 0:n.filter(a=>a.amount>0).reduce((a,C)=>a+C.amount,0))??0,T=Math.abs((n==null?void 0:n.filter(a=>a.amount<0).reduce((a,C)=>a+C.amount,0))??0);g(y),b(T),h(null)}catch(s){console.error("Error fetching token balance:",s),h(s instanceof Error?s.message:"Failed to fetch token balance")}finally{u(!1)}};return o.useEffect(()=>{p()},[r==null?void 0:r.id]),{balance:x,totalEarned:d,totalSpent:m,loading:w,error:k,refetch:p,fetchTransactions:async(s=50)=>{if(!r)return[];try{const{data:t,error:n}=await v.from("credit_transactions").select("*").eq("user_id",r.id).order("created_at",{ascending:!1}).limit(s);if(n)throw n;return t||[]}catch(t){return console.error("Error fetching credit transactions:",t),[]}}}},H=()=>{const r=W(),[x]=_(),{refetch:l}=Z(),{user:d}=z(),[g,m]=o.useState(!0),[b,w]=o.useState(!1),[u,k]=o.useState(!1);return o.useEffect(()=>{const h=x.get("session_id");if(!h){r("/tokens/buy");return}const p=async()=>{if(!d)return!1;const{data:t,error:n}=await v.from("donations").select("id, created_at").eq("stripe_session_id",h).eq("user_id",d.id).maybeSingle();return n?(console.error("Error checking donation:",n),!1):!!t},s=(async()=>{let t=0;const n=20,c=setInterval(async()=>{t++;const y=await p();console.log(`Poll ${t}: donation processed=${y}`),y?(console.log("Payment confirmed!"),w(!0),m(!1),clearInterval(c),l()):t>=n&&(console.log("Polling timeout - payment not processed"),k(!0),m(!1),clearInterval(c))},1e3);return()=>clearInterval(c)})();return()=>{s.then(t=>t&&t())}},[x,r,l,d]),e.jsx(f,{sx:{bgcolor:"#fafafa",minHeight:"100vh",py:8},children:e.jsx(P,{maxWidth:"sm",children:e.jsx(R,{sx:{p:6,borderRadius:3,textAlign:"center",boxShadow:3},children:g?e.jsxs(e.Fragment,{children:[e.jsx(I,{size:64,sx:{mb:3}}),e.jsx(i,{variant:"h5",sx:{fontWeight:700,mb:2},children:"Zahlung wird verarbeitet..."}),e.jsx(i,{variant:"body1",color:"text.secondary",children:"Bitte warte einen Moment, während wir deine Credits gutschreiben."})]}):u?e.jsxs(e.Fragment,{children:[e.jsx(f,{sx:{display:"inline-flex",p:3,borderRadius:"50%",bgcolor:"warning.main",color:"white",mb:3},children:e.jsx(B,{size:64})}),e.jsx(i,{variant:"h4",sx:{fontWeight:900,mb:2},children:"Zahlung erfolgreich, Credits verzögert"}),e.jsx(i,{variant:"body1",color:"text.secondary",sx:{mb:2},children:"Deine Zahlung wurde erfolgreich verarbeitet, aber die Credits konnten noch nicht gutgeschrieben werden."}),e.jsx(i,{variant:"body2",color:"text.secondary",sx:{mb:4},children:"Bitte warte einige Minuten oder kontaktiere den Support, falls die Credits nicht innerhalb von 10 Minuten erscheinen."}),e.jsxs(f,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(j,{fullWidth:!0,variant:"contained",size:"large",startIcon:e.jsx(S,{size:20}),onClick:()=>r("/settings?section=tokens"),sx:{textTransform:"none",fontWeight:600,py:1.5,borderRadius:2},children:"Zur Credits-Übersicht"}),e.jsx(j,{fullWidth:!0,variant:"outlined",size:"large",onClick:()=>window.location.reload(),sx:{textTransform:"none",fontWeight:600,py:1.5,borderRadius:2},children:"Seite neu laden"})]})]}):b?e.jsxs(e.Fragment,{children:[e.jsx(f,{sx:{display:"inline-flex",p:3,borderRadius:"50%",bgcolor:"success.main",color:"white",mb:3},children:e.jsx(A,{size:64})}),e.jsx(i,{variant:"h4",sx:{fontWeight:900,mb:2},children:"Zahlung erfolgreich!"}),e.jsx(i,{variant:"body1",color:"text.secondary",sx:{mb:4},children:"Deine Credits wurden erfolgreich gutgeschrieben und stehen dir jetzt zur Verfügung."}),e.jsxs(f,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(j,{fullWidth:!0,variant:"contained",size:"large",startIcon:e.jsx(S,{size:20}),onClick:()=>r("/settings?section=tokens"),sx:{textTransform:"none",fontWeight:600,py:1.5,borderRadius:2},children:"Zur Credits-Übersicht"}),e.jsx(j,{fullWidth:!0,variant:"outlined",size:"large",endIcon:e.jsx(F,{size:20}),onClick:()=>r("/create"),sx:{textTransform:"none",fontWeight:600,py:1.5,borderRadius:2},children:"Jetzt Inserat erstellen"})]})]}):null})})})};export{H as TokenSuccessPage};
