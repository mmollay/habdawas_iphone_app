import{g as is,a as ns,r as t,u as as,j as e,s as rs,c as ls,b as os,T as C,aj as cs,B as a,J as Y,ag as ds,ae as A,ak as Z,I as ee,al as qe,am as He,w as I,an as hs,ao as us,n as T,a8 as ps,ap as L,W as gs,R as xs,H as ms,f as fs,h as js,G as j,$ as J,a2 as Re,F as Q,y as w,aq as ys,a4 as $e,X as bs,D as Cs,i as _s,l as Ss,A as vs}from"./index-Cr_aSuNE.js";import{M as ws,B as ks,D as Ds}from"./MultiImageUpload-DylqVYMt.js";import{C as Ke}from"./Collapse-DR9hVEqK.js";import{R as As,a as X}from"./RadioGroup-BxuBdUxa.js";import{A as Ge}from"./arrow-left-DFM7ANa-.js";import{S as Is}from"./star-DmQVCCzy.js";function zs(l){return is("MuiDialogContentText",l)}ns("MuiDialogContentText",["root"]);const Ws=l=>{const{classes:o}=l,_=os({root:["root"]},zs,o);return{...o,..._}},Es=rs(C,{shouldForwardProp:l=>cs(l)||l==="classes",name:"MuiDialogContentText",slot:"Root"})({}),Ps=t.forwardRef(function(o,c){const _=as({props:o,name:"MuiDialogContentText"}),{children:r,className:z,...S}=_,y=Ws(S);return e.jsx(Es,{component:"p",variant:"body1",color:"textSecondary",ref:c,ownerState:S,className:ls(y.root,z),..._,classes:y})}),Bs=({shippingEnabled:l,shippingCostType:o,shippingCost:c,shippingDescription:_,pickupEnabled:r,selectedAddressId:z,showLocationPublicly:S,locationDescription:y,addresses:U,onShippingEnabledChange:k,onShippingCostTypeChange:h,onShippingCostChange:H,onShippingDescriptionChange:R,onPickupEnabledChange:u,onSelectedAddressChange:$,onShowLocationPubliclyChange:M,onLocationDescriptionChange:W,isMobile:v=!1,hideShippingPickupToggles:p=!1})=>{const[g,E]=t.useState(!0),[x,P]=t.useState(!0),D=U.filter(i=>i.address_type==="pickup_only"||i.address_type==="both");return e.jsxs(a,{children:[!p&&e.jsx(C,{variant:"h6",fontWeight:600,gutterBottom:!0,children:"Versand & Abholung"}),e.jsxs(a,{sx:{display:"flex",flexDirection:"column",gap:2},children:[l&&e.jsxs(Y,{elevation:0,sx:{border:"1px solid",borderColor:"divider",overflow:"hidden"},children:[!p&&e.jsxs(a,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",p:2,cursor:"pointer",bgcolor:g?"rgba(25, 118, 210, 0.04)":"transparent"},onClick:()=>E(!g),children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(ds,{size:20,color:"#1976d2"}),e.jsx(C,{variant:"subtitle1",fontWeight:600,children:"Versand"})]}),e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(A,{control:e.jsx(Z,{checked:l,onChange:i=>{i.stopPropagation(),k(i.target.checked)},onClick:i=>i.stopPropagation()}),label:"",sx:{m:0}}),e.jsx(ee,{size:"small",onClick:()=>E(!g),children:g?e.jsx(qe,{size:20}):e.jsx(He,{size:20})})]})]}),e.jsxs(Ke,{in:p||g&&l,children:[!p&&e.jsx(I,{}),e.jsxs(a,{sx:{p:2,display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(hs,{children:[e.jsx(us,{children:"Versandkosten"}),e.jsxs(As,{value:o,onChange:i=>h(i.target.value),children:[e.jsx(A,{value:"free",control:e.jsx(X,{}),label:"Kostenloser Versand"}),e.jsx(A,{value:"fixed",control:e.jsx(X,{}),label:"Fester Betrag"}),e.jsx(A,{value:"ai_calculated",control:e.jsx(X,{}),label:"KI-berechnet (basierend auf Gewicht & Maßen)"})]})]}),o==="fixed"&&e.jsx(T,{label:"Versandkosten",type:"number",value:c,onChange:i=>H(parseFloat(i.target.value)||0),fullWidth:!0,inputProps:{min:0,step:.5},helperText:"in Euro (€)"}),e.jsx(T,{label:"Versandinformationen",value:_,onChange:i=>R(i.target.value),fullWidth:!0,multiline:!0,rows:v?2:3,placeholder:"z.B. Versand mit DHL, 1-3 Werktage"})]})]})]}),r&&e.jsxs(Y,{elevation:0,sx:{border:"1px solid",borderColor:"divider",overflow:"hidden"},children:[!p&&e.jsxs(a,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",p:2,cursor:"pointer",bgcolor:x?"rgba(25, 118, 210, 0.04)":"transparent"},onClick:()=>P(!x),children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(ps,{size:20,color:"#1976d2"}),e.jsx(C,{variant:"subtitle1",fontWeight:600,children:"Abholung"})]}),e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(A,{control:e.jsx(Z,{checked:r,onChange:i=>{i.stopPropagation(),u(i.target.checked)},onClick:i=>i.stopPropagation()}),label:"",sx:{m:0}}),e.jsx(ee,{size:"small",onClick:()=>P(!x),children:x?e.jsx(qe,{size:20}):e.jsx(He,{size:20})})]})]}),e.jsxs(Ke,{in:p||x&&r,children:[!p&&e.jsx(I,{}),e.jsxs(a,{sx:{p:2,display:"flex",flexDirection:"column",gap:2},children:[e.jsx(T,{label:"Abholadresse",value:z,onChange:i=>$(i.target.value),fullWidth:!0,select:!0,helperText:D.length===0?"Bitte füge eine Abholadresse in den Einstellungen hinzu":"",children:D.length===0?e.jsx(L,{value:"",children:"Keine Adresse verfügbar"}):D.map(i=>e.jsx(L,{value:i.id,children:e.jsxs(a,{children:[e.jsx(C,{variant:"body2",fontWeight:600,children:i.name}),e.jsxs(C,{variant:"caption",color:"text.secondary",children:[i.address,", ",i.postal_code," ",i.city]})]})},i.id))}),e.jsx(A,{control:e.jsx(Z,{checked:S,onChange:i=>M(i.target.checked)}),label:"Vollständige Adresse öffentlich anzeigen"}),e.jsx(T,{label:"Abholhinweise",value:y,onChange:i=>W(i.target.value),fullWidth:!0,multiline:!0,rows:v?2:3,placeholder:"z.B. Hinterhof, Klingel oben rechts"})]})]})]})]})]})},Ns=()=>{const{id:l}=gs(),o=xs(),{user:c}=ms(),_=fs(),r=js(_.breakpoints.down("md")),[z,S]=t.useState(!0),[y,U]=t.useState(!1),[k,h]=t.useState(null),[H,R]=t.useState(!1),[u,$]=t.useState(null),[M,W]=t.useState([]),[v,p]=t.useState(""),[g,E]=t.useState(""),[x,P]=t.useState(""),[D,i]=t.useState(""),[se,te]=t.useState(""),[ie,ne]=t.useState(""),[K,ae]=t.useState([]),[re,le]=t.useState("published"),[Oe,F]=t.useState(!1),[V,oe]=t.useState(!1),[ce,de]=t.useState(""),[he,ue]=t.useState(""),[pe,ge]=t.useState(""),[xe,me]=t.useState(""),[fe,je]=t.useState(""),[ye,be]=t.useState(""),[G,Ce]=t.useState([]),[_e,Se]=t.useState(""),[ve,we]=t.useState(""),[ke,De]=t.useState(!1),[O,Ae]=t.useState("fixed"),[Ie,ze]=t.useState(5),[We,Ee]=t.useState(""),[N,Pe]=t.useState(!0),[B,Be]=t.useState(""),[Te,Le]=t.useState(!1),[Ue,Me]=t.useState(""),[Ze,Je]=t.useState([]);t.useEffect(()=>{if(!c){o("/");return}Qe(),Xe()},[l,c]);const Qe=async()=>{var n;if(!(!l||!c))try{const{data:s,error:b}=await j.from("items").select("*").eq("id",l).maybeSingle();if(b)throw b;if(!s){h("Artikel nicht gefunden"),S(!1);return}if(s.user_id!==c.id){h("Keine Berechtigung zum Bearbeiten dieses Artikels"),S(!1);return}$(s),p(s.title||""),E(s.description||""),P(((n=s.price)==null?void 0:n.toString())||""),i(s.category||""),te(s.brand||""),ne(s.condition||""),ae(s.tags||[]),le(s.status||"published"),de(s.size||""),ue(s.weight||""),ge(s.dimensions_length||""),me(s.dimensions_width||""),je(s.dimensions_height||""),be(s.material||""),Ce(s.colors||[]),Se(s.style||""),we(s.serial_number||""),De(s.snapshot_shipping_enabled||!1),Ae(s.snapshot_shipping_cost_type||"fixed"),ze(s.snapshot_shipping_cost||5),Ee(s.snapshot_shipping_description||""),Pe(s.snapshot_pickup_enabled||!1),Be(s.selected_address_id||""),Le(s.snapshot_show_location_publicly||!1),Me(s.snapshot_location_description||"");const{data:m}=await j.from("item_images").select("*").eq("item_id",l).order("display_order",{ascending:!0});m&&m.length>0?W(m.map(f=>({id:f.id,preview:f.image_url,existingUrl:f.image_url,isPrimary:f.is_primary}))):s.image_url&&W([{id:"primary",preview:s.image_url,existingUrl:s.image_url,isPrimary:!0}])}catch(s){console.error("Error loading item:",s),h("Fehler beim Laden des Artikels")}finally{S(!1)}},Xe=async()=>{if(c)try{const{data:n,error:s}=await j.from("addresses").select("*").eq("user_id",c.id).in("address_type",["pickup_only","both"]).order("is_default",{ascending:!1});if(s)throw s;Je(n||[])}catch(n){console.error("Error loading addresses:",n)}},Ye=async()=>{if(!(!c||!u)){oe(!0),h(null);try{const{error:n}=await j.from("items").delete().eq("id",u.id);if(n)throw n;o("/")}catch(n){console.error("Error deleting item:",n),h(n.message||"Fehler beim Löschen"),oe(!1),F(!1)}}},es=async()=>{if(!(!c||!u)){if(!v.trim()||!g.trim()||!x){h("Bitte fülle alle Pflichtfelder aus");return}U(!0),h(null);try{const n=parseFloat(x.replace(",","."));if(isNaN(n))throw new Error("Ungültiger Preis");let s=u.image_url;await j.from("item_images").delete().eq("item_id",u.id);const b=[];for(const d of M){let q;if(d.file){const ss=d.file.name.split(".").pop(),Ve=`${c.id}/${Date.now()}-${Math.random().toString(36).substring(7)}.${ss}`,{error:Ne}=await j.storage.from("item-images").upload(Ve,d.file);if(Ne)throw Ne;const{data:{publicUrl:ts}}=j.storage.from("item-images").getPublicUrl(Ve);q=ts}else if(d.existingUrl)q=d.existingUrl;else continue;b.push(q),d.isPrimary&&(s=q)}for(let d=0;d<b.length;d++)await j.from("item_images").insert({item_id:u.id,image_url:b[d],display_order:d,is_primary:b[d]===s});let m=null;if(N&&B){const{data:d}=await j.from("addresses").select("*").eq("id",B).maybeSingle();m=d}const f={title:v.trim(),description:g.trim(),price:n,category:D||null,brand:se||null,condition:ie||null,tags:K.length>0?K:null,status:re,size:ce||null,weight:he||null,dimensions_length:pe||null,dimensions_width:xe||null,dimensions_height:fe||null,material:ye||null,colors:G.length>0?G:null,style:_e||null,serial_number:ve||null,image_url:s,selected_address_id:N&&B?B:null,snapshot_shipping_enabled:ke,snapshot_shipping_cost_type:O,snapshot_shipping_cost:O==="fixed"?Ie:0,snapshot_shipping_description:We||null,snapshot_pickup_enabled:N,snapshot_show_location_publicly:Te,snapshot_location_description:Ue||null,updated_at:new Date().toISOString()};m&&(f.snapshot_pickup_address=m.address,f.snapshot_pickup_postal_code=m.postal_code,f.snapshot_pickup_city=m.city,f.snapshot_pickup_country=m.country);const{error:Fe}=await j.from("items").update(f).eq("id",u.id);if(Fe)throw Fe;R(!0),setTimeout(()=>{o(`/item/${u.id}`)},1500)}catch(n){console.error("Error saving item:",n),h(n.message||"Fehler beim Speichern")}finally{U(!1)}}};return z?e.jsx(a,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh"},children:e.jsx(J,{})}):k&&!u?e.jsx(a,{sx:{minHeight:"100vh",display:"flex",flexDirection:"column"},children:e.jsxs(Re,{maxWidth:"md",sx:{py:8,flex:1},children:[e.jsx(Q,{severity:"error",children:k}),e.jsx(w,{variant:"outlined",onClick:()=>o("/"),sx:{mt:2},startIcon:e.jsx(Ge,{size:20}),children:"Zurück zur Startseite"})]})}):e.jsxs(a,{sx:{minHeight:"100vh",display:"flex",flexDirection:"column",bgcolor:"#fafafa"},children:[e.jsxs(Re,{maxWidth:"lg",sx:{py:r?2:4,flex:1,maxWidth:"1200px !important"},children:[e.jsxs(a,{sx:{mb:3,display:"flex",alignItems:"center",gap:2,flexWrap:"wrap"},children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:2,flex:1},children:[e.jsx(ee,{onClick:()=>o(`/item/${l}`),size:r?"small":"medium",children:e.jsx(Ge,{size:r?20:24})}),e.jsx(C,{variant:r?"h5":"h4",fontWeight:600,children:"Artikel bearbeiten"})]}),!r&&e.jsx(w,{variant:"outlined",onClick:()=>o("/"),startIcon:e.jsx(ys,{size:20}),sx:{whiteSpace:"nowrap"},children:"Zurück zur Liste"})]}),k&&e.jsx(Q,{severity:"error",sx:{mb:3},onClose:()=>h(null),children:k}),H&&e.jsx(Q,{severity:"success",sx:{mb:3},children:"Artikel erfolgreich aktualisiert! Du wirst weitergeleitet..."}),e.jsxs(Y,{elevation:r?0:1,sx:{p:r?2:4},children:[e.jsxs(a,{sx:{display:"flex",flexDirection:"column",gap:4},children:[e.jsxs(a,{children:[e.jsx(C,{variant:"h6",fontWeight:600,gutterBottom:!0,children:"Bilder"}),e.jsx(ws,{images:M,onImagesChange:W})]}),e.jsx(I,{}),e.jsx(ks,{title:v,description:g,price:x,category:D,brand:se,condition:ie,tags:K,onTitleChange:p,onDescriptionChange:E,onPriceChange:P,onCategoryChange:i,onBrandChange:te,onConditionChange:ne,onTagsChange:ae,isMobile:r}),e.jsx(I,{}),e.jsx(Ds,{size:ce,weight:he,dimensionsLength:pe,dimensionsWidth:xe,dimensionsHeight:fe,material:ye,colors:G,style:_e,serialNumber:ve,onSizeChange:de,onWeightChange:ue,onDimensionsChange:(n,s,b)=>{ge(n),me(s),je(b)},onMaterialChange:be,onColorsChange:Ce,onStyleChange:Se,onSerialNumberChange:we,isMobile:r}),e.jsx(I,{}),e.jsx(Bs,{shippingEnabled:ke,shippingCostType:O,shippingCost:Ie,shippingDescription:We,pickupEnabled:N,selectedAddressId:B,showLocationPublicly:Te,locationDescription:Ue,addresses:Ze,onShippingEnabledChange:De,onShippingCostTypeChange:Ae,onShippingCostChange:ze,onShippingDescriptionChange:Ee,onPickupEnabledChange:Pe,onSelectedAddressChange:Be,onShowLocationPubliclyChange:Le,onLocationDescriptionChange:Me,isMobile:r}),e.jsx(I,{}),e.jsxs(a,{children:[e.jsx(C,{variant:"h6",fontWeight:600,gutterBottom:!0,children:"Status & Verwaltung"}),e.jsxs(a,{sx:{display:"flex",flexDirection:"column",gap:2.5},children:[e.jsxs(T,{label:"Artikelstatus",value:re,onChange:n=>le(n.target.value),select:!0,fullWidth:!0,helperText:"Entwürfe sind nur für dich sichtbar",children:[e.jsx(L,{value:"draft",children:"Entwurf"}),e.jsx(L,{value:"published",children:"Veröffentlicht"}),e.jsx(L,{value:"sold",children:"Verkauft"})]}),e.jsx(w,{variant:"outlined",color:"error",onClick:()=>F(!0),startIcon:e.jsx($e,{size:20}),fullWidth:r,sx:{alignSelf:r?"stretch":"flex-start"},children:"Artikel löschen"})]})]})]}),e.jsxs(a,{sx:{mt:4,display:"flex",gap:2,justifyContent:"flex-end",flexWrap:"wrap"},children:[e.jsx(w,{variant:"outlined",onClick:()=>o(`/item/${l}`),startIcon:e.jsx(bs,{size:20}),disabled:y,fullWidth:r,children:"Abbrechen"}),e.jsx(w,{variant:"contained",onClick:es,disabled:y||!v.trim()||!g.trim()||!x,startIcon:y?e.jsx(J,{size:20,color:"inherit"}):e.jsx(Is,{size:20}),fullWidth:r,children:y?"Speichern...":"Änderungen speichern"})]})]})]}),e.jsxs(Cs,{open:Oe,onClose:()=>F(!1),maxWidth:"xs",fullWidth:!0,children:[e.jsx(_s,{children:"Artikel löschen?"}),e.jsx(Ss,{children:e.jsx(Ps,{children:"Möchtest du diesen Artikel wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden."})}),e.jsxs(vs,{children:[e.jsx(w,{onClick:()=>F(!1),disabled:V,children:"Abbrechen"}),e.jsx(w,{onClick:Ye,color:"error",variant:"contained",disabled:V,startIcon:V?e.jsx(J,{size:20,color:"inherit"}):e.jsx($e,{size:20}),children:V?"Lösche...":"Löschen"})]})]})]})};export{Ns as ItemEditPage};
