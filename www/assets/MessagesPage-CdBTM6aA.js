import{g as se,a as ae,r as d,u as ne,aU as oe,j as t,s as ie,c as le,b as de,H as ce,aV as xe,f as he,h as ue,a3 as H,a0 as G,J as me,B as s,T as i,I as C,aW as pe,L as ge,q as fe,aX as be,V as X,v as z,a7 as Y,aa as ye,w as je,aY as we,a2 as ve,aZ as Se,n as _e,a_ as Ce,ar as $,G as u}from"./index-DGPOwJJr.js";import{u as Ie}from"./index-BcVG1dEp.js";import{A as ke}from"./arrow-left-Dg_Vpcc7.js";import{S as ze}from"./send-Dsz_AqS5.js";function We(a){return se("MuiListItemAvatar",a)}ae("MuiListItemAvatar",["root","alignItemsFlexStart"]);const Me=a=>{const{alignItems:h,classes:m}=a;return de({root:["root",h==="flex-start"&&"alignItemsFlexStart"]},We,m)},Re=ie("div",{name:"MuiListItemAvatar",slot:"Root",overridesResolver:(a,h)=>{const{ownerState:m}=a;return[h.root,m.alignItems==="flex-start"&&h.alignItemsFlexStart]}})({minWidth:56,flexShrink:0,variants:[{props:{alignItems:"flex-start"},style:{marginTop:8}}]}),Le=d.forwardRef(function(h,m){const e=ne({props:h,name:"MuiListItemAvatar"}),{className:x,...I}=e,o=d.useContext(oe),p={...e,alignItems:o.alignItems},b=Me(p);return t.jsx(Re,{className:le(b.root,x),ownerState:p,ref:m,...I})}),Ue=()=>{var B,N,P,F,K,O;const{user:a}=ce(),{getCached:h}=xe(),m=he(),e=ue(m.breakpoints.down("md")),[x,I]=d.useState([]),[o,p]=d.useState(null),[b,J]=d.useState([]),[y,W]=d.useState(""),[Q,M]=d.useState(!0),[k,R]=d.useState(!1),[L,j]=d.useState(!0),A=d.useRef(null),D=d.useRef(null),[T,w]=d.useState(null),Z=Ie({onSwipedRight:()=>{e&&o&&(j(!0),p(null))},trackMouse:!1,preventScrollOnSwipe:!0,delta:50}),ee=()=>{var r;(r=A.current)==null||r.scrollIntoView({behavior:"smooth"})},E=async()=>{if(a){M(!0);try{const[r,n]=await Promise.all([u.from("conversations").select("*").eq("buyer_id",a.id).order("updated_at",{ascending:!1}),u.from("conversations").select("*").eq("seller_id",a.id).order("updated_at",{ascending:!1})]);if(r.error)throw r.error;if(n.error)throw n.error;const l=[...r.data||[],...n.data||[]].sort((c,g)=>new Date(g.updated_at).getTime()-new Date(c.updated_at).getTime()),f=await Promise.all((l||[]).map(async c=>{var V;const g=c.buyer_id===a.id?c.seller_id:c.buyer_id,[v,S,_]=await Promise.all([h(`items:${c.item_id}`,async()=>await u.from("items").select("*").eq("id",c.item_id).maybeSingle(),6e4),h(`profile:${g}:full`,async()=>await u.from("profiles").select("*").eq("id",g).maybeSingle(),6e4),u.from("messages").select("*").eq("conversation_id",c.id).order("created_at",{ascending:!1}).limit(1)]),te=await u.from("messages").select("id",{count:"exact"}).eq("conversation_id",c.id).eq("read",!1).neq("sender_id",a.id);return{...c,item:v.data||void 0,other_user:S.data||void 0,last_message:(V=_.data)==null?void 0:V[0],unread_count:te.count||0}}));I(f)}catch(r){console.error("Error loading conversations:",r)}finally{M(!1)}}},U=async r=>{try{const{data:n,error:l}=await u.from("messages").select("*").eq("conversation_id",r).order("created_at",{ascending:!0});if(l)throw l;J(n||[]),await u.from("messages").update({read:!0}).eq("conversation_id",r).neq("sender_id",(a==null?void 0:a.id)||""),setTimeout(ee,100)}catch(n){console.error("Error loading messages:",n)}},q=async()=>{var r;if(!(!y.trim()||!o||!a)){R(!0);try{const{error:n}=await u.from("messages").insert({conversation_id:o.id,sender_id:a.id,content:y.trim()});if(n)throw n;W(""),await U(o.id),await E(),(r=D.current)==null||r.focus()}catch(n){console.error("Error sending message:",n)}finally{R(!1)}}};return d.useEffect(()=>{E()},[a]),d.useEffect(()=>{o&&(U(o.id),e&&j(!1))},[o,e]),d.useEffect(()=>{if(x.length>0&&!o){const r=x.find(n=>(n.unread_count||0)>0);r&&p(r)}},[x]),Q?t.jsx(H,{maxWidth:"xl",sx:{py:e?0:4,height:e?"100%":"auto",flex:e?1:"unset",display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsx(G,{size:48,thickness:4})}):t.jsxs(H,{maxWidth:"xl",sx:{py:e?0:3,px:e?0:2,height:e?"100%":"calc(100vh - 88px)",flex:e?1:"unset"},children:[t.jsxs(me,{elevation:e?0:2,sx:{height:"100%",display:"flex",overflow:"hidden",borderRadius:e?0:3,bgcolor:"background.paper"},children:[t.jsxs(s,{sx:{width:e?"100%":380,borderRight:1,borderColor:"divider",display:e&&!L?"none":"flex",flexDirection:"column",bgcolor:"background.default"},children:[t.jsxs(s,{sx:{p:e?2:3,bgcolor:"primary.main",color:"primary.contrastText"},children:[t.jsxs(s,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:e?1.5:1},children:[t.jsx(i,{variant:e?"h6":"h5",fontWeight:600,children:"Nachrichten"}),!e&&t.jsx(C,{size:"small",sx:{color:"primary.contrastText"},children:t.jsx(pe,{size:20})})]}),x.length>0&&t.jsxs(i,{variant:"body2",sx:{opacity:.9},children:[x.length," ",x.length===1?"Konversation":"Konversationen"]})]}),t.jsx(ge,{sx:{flex:1,overflow:"auto",p:0},children:x.length===0?t.jsxs(s,{sx:{p:e?3:4,textAlign:"center"},children:[t.jsx(i,{variant:"body1",color:"text.secondary",sx:{mb:1},children:"Keine Konversationen"}),t.jsx(i,{variant:"body2",color:"text.secondary",children:"Starte eine Unterhaltung über ein Angebot"})]}):x.map((r,n)=>{var l,f,c,g,v,S,_;return t.jsxs(s,{children:[t.jsxs(fe,{selected:(o==null?void 0:o.id)===r.id,onClick:()=>{p(r),e&&j(!1)},sx:{py:e?2:2.5,px:e?2:2.5,transition:"all 0.2s ease","&.Mui-selected":{bgcolor:"primary.lighter",borderLeft:4,borderColor:"primary.main","&:hover":{bgcolor:"primary.lighter"}},"&:hover":{bgcolor:"action.hover"}},children:[t.jsx(Le,{children:t.jsx(be,{overlap:"circular",anchorOrigin:{vertical:"bottom",horizontal:"right"},badgeContent:r.unread_count>0?t.jsx(s,{sx:{width:e?18:20,height:e?18:20,borderRadius:"50%",bgcolor:"error.main",color:"white",display:"flex",alignItems:"center",justifyContent:"center",fontSize:e?"0.7rem":"0.75rem",fontWeight:600,border:"2px solid white"},children:r.unread_count>9?"9+":r.unread_count}):null,children:t.jsx(X,{src:(l=r.item)==null?void 0:l.image_url,sx:{width:e?52:56,height:e?52:56,border:"2px solid",borderColor:"background.paper",boxShadow:1},children:((g=(c=(f=r.other_user)==null?void 0:f.full_name)==null?void 0:c[0])==null?void 0:g.toUpperCase())||"?"})})}),t.jsx(z,{sx:{ml:1.5},primary:t.jsxs(s,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:.5},children:[t.jsx(i,{variant:"subtitle1",fontWeight:r.unread_count>0?600:500,noWrap:!0,sx:{flex:1,mr:1,fontSize:e?"0.95rem":"1rem"},children:((v=r.other_user)==null?void 0:v.full_name)||"Unbekannt"}),r.last_message&&t.jsx(i,{variant:"caption",color:"text.secondary",sx:{flexShrink:0,fontSize:e?"0.7rem":"0.75rem"},children:ye(r.last_message.created_at)})]}),secondary:t.jsxs(t.Fragment,{children:[t.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:.5,mb:.5},children:[t.jsx(Y,{size:e?12:14,style:{opacity:.6}}),t.jsx(i,{variant:"caption",color:"text.secondary",noWrap:!0,component:"span",sx:{fontWeight:500,fontSize:e?"0.7rem":"0.75rem"},children:((S=r.item)==null?void 0:S.title)||"Item gelöscht"})]}),t.jsx(i,{variant:"body2",color:r.unread_count>0?"text.primary":"text.secondary",fontWeight:r.unread_count>0?500:400,noWrap:!0,component:"span",sx:{fontSize:e?"0.85rem":"0.875rem"},children:((_=r.last_message)==null?void 0:_.content)||"Noch keine Nachrichten"})]}),secondaryTypographyProps:{component:"div"}})]}),n<x.length-1&&t.jsx(je,{variant:"inset",component:"li"})]},r.id)})})]}),t.jsx(s,{...Z,sx:{flex:1,display:e&&L?"none":"flex",flexDirection:"column",touchAction:"pan-y",bgcolor:"background.default"},children:o?t.jsxs(t.Fragment,{children:[t.jsx(s,{sx:{p:e?1.5:2.5,bgcolor:"background.paper",borderBottom:1,borderColor:"divider",boxShadow:e?"0 2px 4px rgba(0,0,0,0.08)":"0 1px 3px rgba(0,0,0,0.05)"},children:t.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:e?1.5:2},children:[e&&t.jsx(C,{onClick:()=>{j(!0),p(null)},size:"small",sx:{"&:hover":{bgcolor:"action.hover"}},children:t.jsx(ke,{size:22})}),t.jsx(X,{src:(B=o.item)==null?void 0:B.image_url,sx:{width:e?40:48,height:e?40:48,border:"2px solid",borderColor:"primary.main",boxShadow:1},children:((F=(P=(N=o.other_user)==null?void 0:N.full_name)==null?void 0:P[0])==null?void 0:F.toUpperCase())||"?"}),t.jsxs(s,{sx:{flex:1,minWidth:0},children:[t.jsx(i,{variant:e?"body1":"subtitle1",fontWeight:600,noWrap:!0,children:((K=o.other_user)==null?void 0:K.full_name)||"Unbekannt"}),t.jsxs(s,{sx:{display:"flex",alignItems:"center",gap:.5},children:[t.jsx(Y,{size:e?11:12,style:{opacity:.6}}),t.jsx(i,{variant:"caption",color:"text.secondary",noWrap:!0,sx:{fontSize:e?"0.7rem":"0.75rem"},children:((O=o.item)==null?void 0:O.title)||"Item gelöscht"})]})]}),!e&&t.jsx(C,{size:"small",onClick:r=>w(r.currentTarget),children:t.jsx(we,{size:20})})]})}),t.jsx(s,{sx:{flex:1,overflow:"auto",p:e?2:3,bgcolor:e?"grey.100":"grey.50",backgroundImage:e?"linear-gradient(180deg, rgba(0,0,0,0.02) 0%, rgba(0,0,0,0.03) 100%)":"linear-gradient(180deg, rgba(0,0,0,0.01) 0%, rgba(0,0,0,0.02) 100%)"},children:b.length===0?t.jsx(s,{sx:{height:"100%",display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center",px:3},children:t.jsxs(s,{children:[t.jsx(i,{variant:"body1",color:"text.secondary",gutterBottom:!0,children:"Noch keine Nachrichten"}),t.jsx(i,{variant:"body2",color:"text.secondary",children:"Sende die erste Nachricht"})]})}):t.jsxs(t.Fragment,{children:[b.map((r,n)=>{const l=r.sender_id===(a==null?void 0:a.id),f=n===0||new Date(b[n-1].created_at).toDateString()!==new Date(r.created_at).toDateString();return t.jsxs(s,{children:[f&&t.jsx(s,{sx:{display:"flex",justifyContent:"center",my:e?2:3},children:t.jsx(ve,{label:new Date(r.created_at).toLocaleDateString("de-DE",{weekday:e?"short":"long",year:"numeric",month:e?"short":"long",day:"numeric"}),size:"small",sx:{bgcolor:"background.paper",boxShadow:1,fontWeight:500,fontSize:e?"0.7rem":"0.75rem",height:e?24:28}})}),t.jsx(Se,{in:!0,timeout:300,children:t.jsx(s,{sx:{display:"flex",justifyContent:l?"flex-end":"flex-start",mb:e?1:1.5},children:t.jsxs(s,{sx:{maxWidth:e?"80%":"75%",bgcolor:l?"primary.main":"background.paper",color:l?"primary.contrastText":"text.primary",px:e?1.5:2,py:e?1.25:1.5,borderRadius:l?e?"18px 18px 4px 18px":"20px 20px 4px 20px":e?"18px 18px 18px 4px":"20px 20px 20px 4px",boxShadow:l?2:1,transition:"all 0.2s ease","&:hover":{transform:e?"none":"translateY(-1px)",boxShadow:l?3:2}},children:[t.jsx(i,{variant:"body2",sx:{wordWrap:"break-word",whiteSpace:"pre-wrap",lineHeight:1.5,fontSize:e?"0.9rem":"1rem"},children:r.content}),t.jsx(i,{variant:"caption",sx:{opacity:l?.85:.7,display:"block",mt:.5,fontSize:e?"0.65rem":"0.7rem"},children:new Date(r.created_at).toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"})})]})})})]},r.id)}),t.jsx("div",{ref:A})]})}),t.jsx(s,{sx:{p:e?1.5:2.5,bgcolor:"background.paper",borderTop:1,borderColor:"divider",boxShadow:e?"0 -4px 12px rgba(0,0,0,0.06)":"0 -1px 3px rgba(0,0,0,0.05)"},children:t.jsxs(s,{sx:{display:"flex",gap:e?1:1.5,alignItems:"flex-end",bgcolor:e?"grey.100":"transparent",borderRadius:e?7:0,p:e?.75:0},children:[t.jsx(_e,{fullWidth:!0,inputRef:D,placeholder:"Nachricht...",value:y,onChange:r=>W(r.target.value),onKeyPress:r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),q())},multiline:!0,maxRows:e?3:4,disabled:k,variant:"outlined",size:"small",sx:{"& .MuiOutlinedInput-root":{bgcolor:e?"transparent":"grey.50",borderRadius:e?0:3,fontSize:"0.95rem",py:e?.5:.75,px:1.5,transition:"all 0.2s ease","& fieldset":{borderColor:e?"transparent":"divider",borderWidth:e?0:1},"&:hover":{bgcolor:e?"transparent":"grey.100","& fieldset":{borderColor:e?"transparent":"primary.light"}},"&.Mui-focused":{bgcolor:e?"transparent":"background.paper","& fieldset":{borderColor:e?"transparent":"primary.main",borderWidth:e?0:2}}},"& .MuiOutlinedInput-input":{padding:0}}}),t.jsx(C,{color:"primary",onClick:q,disabled:k||!y.trim(),sx:{bgcolor:"primary.main",color:"white",width:e?46:48,height:e?46:48,flexShrink:0,transition:"all 0.2s cubic-bezier(0.4, 0, 0.2, 1)",boxShadow:2,mr:e?.5:0,display:"flex",alignItems:"center",justifyContent:"center",p:0,"&:hover":{bgcolor:"primary.dark",transform:"scale(1.05)",boxShadow:3},"&:active":{transform:"scale(0.95)"},"&.Mui-disabled":{bgcolor:"grey.300",color:"grey.500",boxShadow:0}},children:k?t.jsx(G,{size:e?20:22,color:"inherit"}):t.jsx(ze,{size:e?20:22,style:{transform:"translateX(1px)"}})})]})})]}):t.jsx(s,{sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center",px:3},children:t.jsxs(s,{children:[t.jsx(i,{variant:e?"h6":"h5",color:"text.secondary",fontWeight:500,gutterBottom:!0,children:"Wähle eine Konversation"}),t.jsxs(i,{variant:"body2",color:"text.secondary",children:["Starte eine Unterhaltung aus der Liste ",e?"oben":"links"]})]})})})]}),t.jsxs(Ce,{anchorEl:T,open:!!T,onClose:()=>w(null),transformOrigin:{horizontal:"right",vertical:"top"},anchorOrigin:{horizontal:"right",vertical:"bottom"},children:[t.jsx($,{onClick:()=>{w(null)},children:t.jsx(z,{children:"Alle als gelesen markieren"})}),t.jsx($,{onClick:()=>{w(null)},children:t.jsx(z,{children:"Konversation archivieren"})})]})]})};export{Ue as MessagesPage};
